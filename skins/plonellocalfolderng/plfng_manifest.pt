<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US"
      lang="en-US"
      i18n:domain="plone"
      metal:use-macro="here/main_template/macros/master">

<body>


  <div metal:fill-slot="main"
     tal:define="folderfilter python:request.get('folderfilter', '');
                 global decodedFilter python:here.decodeFolderFilter(folderfilter);
                 global filterValues decodedFilter;
                 global filter decodedFilter;
                 standalone python:1;
                 folder_props  python:here.getProperties(REQUEST=request);
                 total_vis_size    python:folder_props.get('size',0);
                 total_vis_folders python:folder_props.get('folders',0);
                 total_vis_files   python:folder_props.get('files',0);
                 filteredOutFolderContents python:here.getFilteredOutContents();
                 filteredFolderContents python:here.getFilteredContents();
                 legalFiles python:filteredFolderContents;
                 illegalFiles python:filteredOutFolderContents[0];
                 total_illegal_files python:len(illegalFiles);
                 illegalFolders python:filteredOutFolderContents[1];
                 total_illegal_folders python:len(illegalFolders);
                 hiddenFiles python:filteredOutFolderContents[2];
                 total_hidden_files python:len(hiddenFiles);
                 hiddenFolders python:filteredOutFolderContents[3];
                 total_hidden_folders python:len(hiddenFolders);
                 mtool mtool|here/portal_membership;
                 myfolder python:here.absolute_url()==mtool.getHomeUrl();
                 hiddenFilePrefixes here/hidden_file_prefixes;
                 hiddenFileSuffixes here/hidden_file_suffixes;
                 hiddenFileNames here/hidden_file_names;
                 hiddenFolderNames here/hidden_folder_names;
                 hiddenFolderSuffixes here/hidden_folder_suffixes;
                 hiddenFolderNames here/hidden_folder_names;
                 total_files python:total_vis_files+total_hidden_files+total_illegal_files;
                 total_folders python:total_vis_folders+total_hidden_folders+total_illegal_folders;
                 action python:request.get('action', '');">

     <div>
        <br>
        <b>total # files = </b>
        <span tal:content="total_files">
          files
        </span>
        (<span tal:content="total_vis_files">
          files
        </span> visible
        
        ,
        <span tal:content="total_hidden_files">
          files
        </span> hidden
        ,
        <span tal:content="total_illegal_files">
          files
        </span> illegal
        )
        <br><br>

        <b>total # subfolders = </b>
        <span tal:content="total_folders">
          files
        </span>
        (<span tal:content="total_vis_folders">
          files
        </span> visible
        
        ,
        <span tal:content="total_hidden_folders">
          files
        </span> hidden
        ,
        <span tal:content="total_illegal_folders">
          files
        </span> illegal
        )
        <br><br>
        
        <b>total # bytes used by visible content = </b>
        
        <span tal:content="total_vis_size">
          size
        </span>
        
        <br>
        <br>
        <b>files with legal Plone ID's:</b><br>
        
        <metal:block tal:condition="not: legalFiles">
        <p> none</p> 
        </metal:block>
        <metal:block tal:condition="legalFiles">
         <div tal:condition="python:action=='update'">
           <metal:block tal:repeat="item legalFiles">
 	              <div tal:define="dummy python:here.updateMD5Metadatum(item,'update','')">
                 </div> 
           </metal:block>
           <div tal:define="redir_url string:${request/URL1}/plfng_manifest;
                            dummy python:request.response.redirect(redir_url); " />
         </div>
        
         <br>
         <table id="sortable5"
             class="listing"
             summary="Content listing"
             cellpadding="0" cellspacing="0">
             <thead>
                <tr>
                   <th>MD5</th>
                   <th>Title</th>
                </tr>
             </thead>
           <tbody>
	           <metal:block tal:repeat="item legalFiles">
 	              <div tal:define="current_md5  python:here.updateMD5Metadatum(item,'MD5only','');
 	                               metadata_md5 python:here.getFileMetadata(section='DIAGNOSTICS',option='md5', rel_dir=item);
 	                               fixed_current_md5 python:test(current_md5, current_md5, '');
 	                               md5_status python:test(metadata_md5==current_md5, 'ok', 'bad');
 	                               output_md5 python:test(md5_status=='ok', fixed_current_md5, '*'+fixed_current_md5)">
                  <tr>
                    <td tal:content="output_md5"
                        tal:attributes="bgcolor python:test(md5_status=='ok','white','yellow')">checksum</td>
                    <td i18n:translate="" tal:content="python:item"
                        tal:attributes="bgcolor python:test(md5_status=='ok','white','yellow')">
                      itemName
                    </td>

                  </tr>
                </div> 
              </metal:block>
             </tbody>
           </table>
        <br>
        <br>
          <code>
          <a class="button" tal:attributes="href string:${request/URL1}/plfng_manifest?action=update">Update MD5 metadatum for all files now</a>
          </code>
        </metal:block>
     </div>
  </div>
</body>
</html>
