<metal:macro metal:define-macro="issue_images" i18n:domain="plonecollectorng">
  <tal:def tal:define="images python: here.objectValues(('Portal Image',))">
    <fieldset tal:condition="images"> 
      <legend i18n:translate="images">Images</legend>
      <div tal:repeat="image images">
        <span tal:content="image/getId" />:<br/>
        <img tal:attributes="src image/absolute_url">
        <br/>
      </div>
    </fieldset>
  </tal:def>
</metal:macro>

<metal:block metal:define-macro="field_quoted" i18n:domain="plonecollectorng">
  <span metal:use-macro="python: here.widget(request.get('fieldname'), mode='view', use_label=1)"/>
</metal:block>

<metal:block metal:define-macro="field_shortview" i18n:domain="plonecollectorng">
 <metal:block tal:define="value python: here.getParameter(field.getName())">
    <metal:block tal:condition="value">
      <span class="schemata_label" i18n:translate="" tal:content="python: field.widget.Label(here).strip()" />:

      <tal:if tal:condition="not: field/vocabulary|nothing" >
        <span metal:use-macro="python: here.widget(field.getName(), mode='view', use_label=0)" />
      </tal:if>

      <tal:if tal:condition="field/vocabulary|nothing" >
        <span tal:define="vocab python: field.Vocabulary(here);
                          display python: here.displayValue(vocab, value)"
              tal:replace="structure display" />
      </tal:if> 

    </metal:block>
  </metal:block>
</metal:block>

<fieldset metal:define-macro="view_schemata" i18n:domain="plonecollectorng">
  <legend> <a class="schemata_legend"   
              tal:attributes="href string:pcng_base_edit?fieldset=${schemata_name}">
            <span i18n:translate="" tal:content="schemata_name"/>
           </a></legend>
  <metal:block  tal:repeat="field python: schemata.fields()">
    <span metal:use-macro="here/issue_macros/macros/field_shortview" /> &nbsp;&nbsp;
  </metal:block>
</fieldset>

<div metal:define-macro="view_schemata_as_div" i18n:domain="plonecollectorng">
  <div tal:repeat="field fields">
    <span metal:use-macro="here/issue_macros/macros/field_shortview" /> 
  </div>
</div>

<!-- Issue related macros -->

<div metal:define-macro="issue_references" i18n:domain="plonecollectorng">
  <a name="references"> </a>
  <fieldset tal:define="references here/getForwardReferences;
                        breferences here/getBackReferences" >


    <legend i18n:translate="legend_references">References</legend>

      <ul>

        <li><span i18n:translate="references">References</span>
          <ul>
            <li tal:repeat="ref references">
              <tal:def tal:define="target python: ref.getTargetObject()">
                <a tal:attributes="href target/absolute_url" tal:content="string: ${ref/collector_title|nothing}: ${target/title_or_id}"/>
                [<a tal:attributes="href string: delete_reference?issue_url=${ref/issue_url}">del</a>]
                <pre tal:content="ref/comment" />
              </tal:def>
            </li>
             <li tal:condition="not: references" i18n:translate="no_references">No references found</li>
          </ul>
        </li>

        <li><span i18n:translate="referenced_by">Referenced by</span>
          <ul>
            <li tal:repeat="ref breferences">
              <tal:def tal:define="source python: ref.getSourceObject()">
                <a tal:attributes="href source/absolute_url" tal:content="string: ${ref/collector_title|nothing}: ${source/title_or_id}"/>
                <pre tal:content="ref/comment" />
              </tal:def>
            </li>
            <li tal:condition="not: breferences" i18n:translate="no_references">No references found</li>
          </ul>
        </li>
        <li><span i18n:translate="dependency_graph">Dependency graph</span>: 
          <a href="pcng_references_tree?format=gif">[GIF]</a>
          <a href="pcng_references_tree?format=jpeg">[JPEG]</a>
          <a href="pcng_references_tree?format=png">[PNG]</a>
          <a href="pcng_references_tree?format=svg">[SVG]</a>
          <a href="pcng_references_tree?format=ps">[PS]</a>
        </li>
      </ul>
  </fieldset> 
</div>  


<fieldset metal:define-macro="issue_uploads" i18n:domain="plonecollectorng">
  <a name="uploads"></a>
  <legend i18n:translate="uploads">Uploads</legend>
    <ul>
        <li tal:repeat="item here/objectValues">
            <span tal:define="icon item/getIcon|item/icon|nothing">

              <span tal:condition="icon">
                <img src="" alt="" border="0"
                     tal:attributes="src python: here.portal_url() + '/' + icon;
                                     alt item/Type|nothing" />
              </span>
              <a href="ITEM URL"
                 tal:attributes="href item/absolute_url">
                <span tal:content="string: ${item/getId}" /> 
              </a>

              <span tal:replace="python: '(%s, %s)' % (here.toLocalizedTime(item.created(),long_format=1), item.Creator())" />
              <a i18n:translate="issue_artifacts_table_info_link"
                 tal:attributes="href python:item.absolute_url() + '/view'">[Info]</a>

              <a tal:condition="python: 'TrackerAdmin' in member.getRolesInContext(here)"
                 i18n:translate="issue_artifacts_table_deletion_link"
                 tal:attributes="href string:${here/absolute_url}/upload_remove?id=${item/getId}">[Del]</a>
            </span>
            <pre tal:condition="python: item.getId() != item.title_or_id()" tal:content="item/title_or_id" />


      </li> <!-- End row -->
    <ul>
  <span i18n:translate="issue_artifacts_table_no_uploads_available"
        tal:condition="not: here/objectValues">No uploads available</span>

</fieldset> <!-- End group -->


<fieldset metal:define-macro="add_uploads" i18n:domain="plonecollectorng">
  <legend i18n:translate="legend_artifacts_upload">Upload files or images</legend>
    <form method="post" action="upload_file" enctype="multipart/form-data">

      <div class="row">
          <div class="label required" i18n:translate="file_for_upload">File for upload</div>
          <div class="field"><input type="file" name="uploaded_file" size="40"/></div>
      </div> <!-- End row -->

       <div class="row">
        <div class="label" i18n:translate="add_artifacts_table_comment">Comment</div>
        <div class="field">
          <textarea name="comment" cols="60" rows="5"></textarea>
        </div>
       </div> <!-- End row -->

       <div class="row">
        <div class="field">
          <input type="submit" value="Upload" class="standalone" i18n:attributes="value">
        </div>
       </div> <!-- End row -->
  </form>
</fieldset> <!-- End group -->



<div metal:define-macro="add_references" i18n:domain="plonecollectorng">

<script language="javascript">
function show_tickets() {
    el = document.myform["reference.tracker:record:string"];
    selected = el.selectedIndex;

    if (selected == 0) {
        return 0;
    }

    tracker = el.options[selected].value;
    url = tracker + "/pcng_issue_selection"; 
    win = open(url, "tickets", "width=500, height=600, scrollbars=yes");
}

</script>

  <fieldset>

    <legend i18n:translate="legend_new_reference_to_issue">New reference to other issue</legend>
    <form method="post" action="add_reference" name="myform">

      <div class="row">
        <div class="label" i18n:translate="add_references_table_collector">
          Collector
        </div>
        <div class="field">
          <select name="reference.tracker:record:string">
            <option value="" />
            <metal:block tal:repeat="tracker python:here.superValues(('PloneCollectorNG',))">
              <option tal:attributes="value python: '/'.join(tracker.getPhysicalPath());
                                      selected python: tracker.getId()==here.aq_parent.getId()"
                      tal:content="string: ${tracker/getId} (${tracker/title})" />

            </metal:block>
          </select>
        </div>
      </div> <!-- End row -->

      <div class="row">
        <div class="label required" i18n:translate="add_references_table_issue_number">Issue #</div>
        <div class="field">
          <input type="text" name="reference.ticketnumber:record:string"  value="" size="5" />
          <input class="context" type="button"  onClick="javascript:show_tickets()" value="Select"
                 i18n:attributes="value" />
        </div>
      </div> <!-- End row -->

      <div class="row">
        <div class="label required" i18n:translate="add_references_table_comment">
          Comment
        </div>
        <div class="field">
          <textarea  name="reference.comment:record:string" cols="60" rows="5"></textarea>
        </div>
      </div> <!-- End row -->

      <div class="row">
        <div class="field">
          <input type="submit" value="Submit" class="standalone" i18n:attributes="value">
        </div>
      </div> <!-- End row -->
    </form>
  </fieldset> <!-- End group -->
</div>  <!-- End macro: add_references_table -->


<div metal:define-macro="watchlist" i18n:domain="plonecollectorng">
  <fieldset tal:condition="python: here.wl_getMode()=='anonymous' or 
                                   (here.wl_getMode()=='authenticated' and member.getUserName() != 'Anonymous User') "
            tal:define="email python: member.getProperty('email')">

    <legend i18n:translate="legend_watchlist">Watchlist</legend>

    <metal:block tal:condition="email">
      <div tal:condition="not: python: here.wl_isWatcher(email)">
        <a tal:attributes="href string:${here/absolute_url}/wl_addWatcher?email=${email}"><span i18n:translate="watchlist_subscribe">Subscribe</span></a>
      </div>      
      <div tal:condition="python: here.wl_isWatcher(email)">
        <a tal:attributes="href string:${here/absolute_url}/wl_removeWatcher?email=${email}"><span i18n:translate="watchlist_unsubscribe">Unsubscribe</span></a>
      </div>      
    </metal:block>

    <metal:block tal:condition="not: email">
      <form tal:attributes="action string:${here/absolute_url}/wl_addWatcher">
        <span i18n:translate="email_address">E-Mail address</span>:        
        <input type="text" size="30" name="email" > &nbsp;
        <input type="submit" value="Subscribe to this issue" class="standalone" i18n:attributes="value">>
      </form>
    </metal:block>
  </fieldset>
</div>


<tal:macro metal:define-macro="followup_table" i18n:domain="plonecollectorng">

  <table tal:define="allow_assign python: here.pcng_user_role() in ('TrackerAdmin', 'Supporter', 'Reporter');
                     topics python: here.get_topics_user().keys();
                     gruf_groups here/get_gruf_groups" >
    <tr>
      <th>
        <span tal:condition="allow_assign" i18n:translate="assign_to_users"> Assign to users</span>
      </th>
      <th tal:condition="topics" width="20">
        &nbsp;
      </th>
      <th tal:condition="python: topics or gruf_groups">
        <span tal:condition="allow_assign" i18n:translate="assign_to_group"> Assign to group</span>
      </th>
      <th>&nbsp;</th>
      <th tal:condition="show_actions|nothing"> 
        <span i18n:translate="action">Action</span>
        (<span i18n:translate="workflow_action_current_state">Current state</span>:
         <span i18n:translate="" tal:content="here/status" />)</th>
    </tr>

    <tr> 
      <td valign="top">
        <select tal:condition="allow_assign" name="assignees:list" size="7" multiple>
          <span tal:repeat="u python: here.getTrackerUsers(staff_only=1)">
            <option tal:content="string: ${u/fullname} (${u/username}, ${u/role})"
                    tal:attributes="value u/username;
                                    selected python: u['username'] in assignees" 
             />
          </span>
        </select>
      </td>
      <td tal:condition="topics" width="20">
        &nbsp;
      </td>
      <td valign="top" tal:condition="python: topics or gruf_groups">
        <select tal:condition="allow_assign" name="assignees_group:list" size="7" multiple>
          <option tal:repeat="topic topics" tal:content="string:$topic (TG)" tal:attributes="value topic" />
          <option tal:repeat="group gruf_groups" tal:content="string:$group (GRUF)" tal:attributes="value group" />
        </select>
      </td>
      <td width="100"> </td>

      <td valign="top" tal:condition="show_actions|nothing" 
                       tal:define="actions here/validActions">
        <input class="required" type="radio" name="action" value="comment" checked>
          <span i18n:translate="comment">Comment</span>
        <tal:loop tal:repeat="action actions">
          <br><input type="radio" name="action" 
                     tal:attributes="value action;
                                     CHECKED python: request.get('state','') == action"/>
          <span i18n:translate="" tal:content="action/capitalize" />
        </tal:loop>
      </td>
    </tr>
  </table>
</tal:macro>

<tal:macro metal:define-macro="issue_shortview" i18n:domain="plonecollectorng">

  <h2 class="pcng_transcript"> 
     <a tal:attributes="href string:${issue/getURL}/pcng_issue_view;
                        target python: test(member.getProperty('pcng_issue_in_new_window', 0), '_blank', '_self')">
      <img src="issue_icon.gif" />
      <span tal:replace="issue/getId" />.
      <span tal:replace="issue/Title" />
    </a>

    <!-- have_reportlab should be moved somewhere else -->
    <a tal:condition="have_reportlab" tal:attributes="href string:${issue/getURL}/asPDF"><img src="pdflogo_small.gif"  height="14" width="18" border="0" title="PDF"></a>
  </h2>

  <div id="pcng_issueview_metadata">
    <b i18n:translate="followups"># Followups</b>: <span tal:content="issue/numberFollowups" /> &bull; 
    <b i18n:translate="status">Status</b>: <span i18n:translate="" tal:content="python: here.pcng_format_status(issue.status)" /> &bull; 
    <b i18n:translate="topic">Topic</b>: <span tal:replace="issue/topic" /> &bull;
    <b i18n:translate="importance">Importance</b>:
    <metal:block tal:define="field python: here.atse_getSchema()['importance'];
                             vocab python: field.Vocabulary(here);
                             display python: here.displayValue(vocab, issue.importance)">
        <span tal:content="structure display" />
    </metal:block> &bull;
    <b i18n:translate="assigned">Assigned</b>: <span tal:replace="python: ', '.join(issue.assigned_to)" />
  </div>

  <div id="pcng_issueview_description" 
       tal:content="python: here.shorten_string(issue.Description, maxlength=180)" 
  />

  <div id="pcng_issueview_legend">
    <span i18n:translate="submitted_by">Submitted by</span> <span tal:replace="issue/Creator" /> <span i18n:translate="date_on">on</span> <span tal:replace="python: here.toLocalizedTime(issue.created)" /> &bull; 
    <span i18n:translate="last_modified">Last modified:</span> <span tal:replace="python: here.toLocalizedTime(issue.modified)" />
    (<span tal:replace="python: '%.1f' % (DateTime() - issue.modified)" />
    <span i18n:translate="days_ago">days ago</span>)
  </div>

</tal:macro>
