<html xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      i18n:domain="plonecollectorng">

<body>

<!-- The news box -->

<!-- searchresults -->
<div metal:define-macro="pcng_searchresults" i18n:domain="plonecollectorng">

  <div class="portlet" id="pcng-collector-metadata"
       tal:condition="python: request.SESSION.has_key('pcng_searchresults')">
    <h5 i18n:translate="last_search_results">Results from last search</h5>
    <div class="portletBody" id="pcng_results_portlet"
         tal:define="my_id here/getId;
                     results python: request.SESSION.get('pcng_searchresults', []);
                     issue_ids python: [i[1] for i in results]">
   
      <div tal:condition="python: here.meta_type=='PloneIssueNG' and here.pcng_issue_temporary()" >
        <tal:if tal:condition="python: here.getId() in issue_ids" > 
            <tal:def tal:define=" issue_index python: issue_ids.index(here.getId())">
            <div class="left">
              <a tal:condition="python: issue_index > 0"
                 tal:attributes="href python: results[issue_index-1][0]"><img src="arrowLeft.gif" title="Previous" i18n:attributes="title"></a>
            </div>

            <div class="right">
              <a tal:condition="python: issue_index < len(results)-1 "
                 tal:attributes="href python: results[issue_index+1][0]"><img src="arrowRight.gif" title="Next" i18n:attributes="title"></a>
            </div>
            <div style="clear: both"> </div>
            </tal:def>
        </tal:if>
      </div>

      <ul tal:define="num_results python: len(results);
                      results python: test(num_results > 20, results[:20], results)">
        <li tal:repeat="item results">
          <a tal:attributes="href python: item[0]">
            <span tal:attributes="id python: test(item[1]==my_id, 'selected', '')"
                  tal:content="python: item[1]" />
          </a>
          - <span tal:replace="python: here.shorten_string(item[2], maxlength=40)" />
        </li>        
        <li tal:condition="python: num_results > 20">...</li>        
      </ul>
    </div>
  </div>
</div>

<!-- Collector metadata -->
<div metal:define-macro="collector_metadata" i18n:domain="plonecollectorng">
  <div class="portlet" id="pcng-collector-metadata">
    <h5 i18n:translate="collector_metadata">Collector data</h5>
    <div class="portletBody">
      <ul>
      </ul>
    </div>
  </div>
</div>

<!-- Issue metadata -->
<div metal:define-macro="issue_metadata" i18n:domain="plonecollectorng">
  <div class="portlet" id="pcng-issue-metadata">
    <h5 i18n:translate="issue_metadata">Issue data</h5>
    <div class="portletBody">
      <ul>
        <li>
            <span i18n:translate="creator">Creator</span>:
            <span tal:replace="here/Creator" />
        </li>
        <li>
            <span i18n:translate="created">Created</span>:
            <span tal:replace="python: here.toLocalizedTime(here.created())" />
        </li>
      </ul>
    </div>
  </div>
</div>

<!-- Collector actions portlet -->
<div metal:define-macro="pcng_collector_portlet" i18n:domain="plonecollectorng">
  <div class="portlet" id="pcng_collector_portlet">
    <h5 i18n:translate="collector_actions">Collector actions</h5>
    <div class="portletBody"  id="pcng_portlet_collector">
      <div class="pcng_action" tal:repeat="a actions/object_pcng_collector|nothing">
        <a tal:attributes="href a/url">
          <span class="pcng_action"
                i18n:translate="" 
                tal:attributes="id a/id"
                tal:content="a/name" />
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Collector search portlet -->
<div metal:define-macro="pcng_search_portlet" i18n:domain="plonecollectorng">
  <div class="portlet" id="pcng_search_portlet">
    <h5 i18n:translate="Search">Search</h5>
    <div class="portletBody"  id="pcng_search_portlet">

      <div>
        <span id="pcng_navigation" i18n:translate="Navigation">Navigation:</span>
        <form  method="post" tal:attributes="action string: ${here/absolute_url}/pcng_show_issue">
          <span i18n:translate="show_issue_number">Show issue #</span> 
          <input type="text" name="issuenumber" size="5" /> &nbsp;
        </form>
      </div>

      <br/>
      <div tal:condition="python: member.getUserName() != 'Anonymous User'">
        <span id="pcng_saved_searches" i18n:translate="saved_searches">Saved searches</span>:
        <form method="post" action="pcng_do_search">
          <!-- saved searches are stored as a list of string 'RELATIVE_URL::query_id::QUERY_STRING' -->
          <select name="query"
                  tal:define="url python: test(here.meta_type=='PloneIssueNG', here.aq_parent.absolute_url(1), here.absolute_url(1))">

            <tal:loop  
                      tal:define="searches python: member.getProperty('pcng_saved_searches');
                                  searches python: test(searches , searches, ())" 
                      tal:repeat="saved_search python: [s for s in (here.pcng_member_property(member, 'pcng_saved_searches', ()) or ()) if s.startswith(url)]" >
              <option tal:content="python: saved_search.split('::', 2)[1]" 
                      tal:attributes="value python: saved_search.split('::', 2)[2]"
                  />

            </tal:loop>

          </select>
          <input  src="search_icon.gif" i18n:attributes="value" type="image">
        </form>    
      </div>

      <div tal:condition="python: member.getUserName() != 'Anonymous User'">
        <span id="pcng_saved_searches" i18n:translate="save_this_search_as">save search as</span>:
        <form method="post" action="pcng_save_search">
          <input type="hidden" name="query" tal:attributes="value request/query_string|nothing">
          <input type="text" name="query_id" value="" size="10" maxlength="20">
          <input type="image" src="add_icon.gif" />
          </form>    
      </div>

      <div tal:condition="python: member.getUserName() != 'Anonymous User'">
        <br/>
        <span id="pcng_quicklinks" i18n:translate="quicklinks">Quicklinks:</span>
        <div>
          <a tal:attributes="href string:pcng_view?filter=assigned"><span i18n:translate="issues_assigned_to_me">Issues assigned to me</span></a> 
        </div>
        <div>
          <a tal:attributes="href string:pcng_view?filter=submitted"><span i18n:translate="issues_submitted_by_me">Issues submitted by me</span></a>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Issue actions porlet -->
<div metal:define-macro="pcng_issue_portlet" i18n:domain="plonecollectorng">
  <div class="portlet" id="pcng_issue_portlet">
    <h5 i18n:translate="issue_actions">Issue actions</h5>
    <div class="portletBody" id="pcng_portlet_issue">
      <div class="pcng_action" loop tal:repeat="a actions/object_pcng_issue|nothing">
        <a tal:attributes="href a/url">
          <span i18n:translate="" 
                tal:attributes="id a/id"
                tal:content="a/name" />
        </a>
      </div>
    </div>
  </div>
</div>

<div metal:define-macro="pcng_issue_references" i18n:domain="plonecollectorng"
     tal:define="canFollowup python: member.has_permission('PloneCollectorNG: Add PloneCollectorNG issue followup' , here);
                 references here/getForwardReferences">
  <div class="portlet" tal:condition="references">
    <h5>
      <span i18n:translate="references">References</span>
      <a tal:condition="canFollowup" href="pcng_issue_references">
        <img src="edit.gif" title="Create new references" i18n:attributes="title"/>
      </a>
    </h5>
    <div class="portletBody" id="pcng_portlet_references">
      <ul>
        <li tal:repeat="ref references">
          <a tal:define="target ref/getTargetObject"
             tal:attributes="href target/absolute_url;
                             title ref/comment;" 
             tal:content="string: ${ref/collector_title|nothing}: ${target/title_or_id}"/>
        </li>
      </ul>
      <span tal:condition="not: references" i18n:translate="no_references">No references</span>
    </div>
  </div>
</div>


<div metal:define-macro="pcng_issue_uploads" i18n:domain="plonecollectorng"
     tal:define="canFollowup python: member.has_permission('PloneCollectorNG: Add PloneCollectorNG issue followup' , here);
                 uploads here/objectValues">
  <div class="portlet" tal:condition="uploads">
    <h5>
      <span i18n:translate="Uploads">Uploads</span>
      <a tal:condition="canFollowup" href="pcng_issue_uploads">
        <img src="edit.gif" title="Upload file" i18n:attributes="title"/>
      </a>
    </h5>
    <div class="portletBody" id="pcng_portlet_uploads">
      <ul>
        <li tal:repeat="item uploads">
          <img src="file_icon.gif" tal:condition="python: item.meta_type=='Portal File'">
          <img src="image_icon.gif" tal:condition="python: item.meta_type=='Portal Image'">
          <a tal:attributes="href item/absolute_url">
            <span  tal:content="python: here.shorten_string1(item.getId(), 16)" 
                   tal:attributes="title python: '(%s, %s): %s' % (here.toLocalizedTime(item.created(),long_format=1), item.Creator(), item.title_or_id())" />
          </a>
        </li>
      </ul>
      <span tal:condition="not: uploads" i18n:translate="no_uploads">No uploads</span>
    </div>
  </div>
</div>


<div metal:define-macro="issue_uploads_portlet" i18n:domain="plonecollectorng">
  <div class="portlet">
    <h5 i18n:translate="uploads">Uploads</h5>
    <div class="portletBody" id="pcng_portlet_uploads">

      <div class="clear" tal:repeat="item here/objectValues">

        <div class="left"
             tal:define="icon item/getIcon|item/icon|nothing">

            <span tal:condition="icon">
              <img src="" alt="" border="0"
                   tal:attributes="src python: here.portal_url() + '/' + icon;
                                   alt item/Type|nothing" />
            </span>
            <a href="ITEM URL"
               tal:attributes="href item/absolute_url">
              <span tal:content="string: ${item/getId}" /> 
            </a>

            <span tal:replace="python: '(%s, %s)' % (here.toLocalizedTime(item.created(),long_format=1), item.Creator())" />
        </div>

        <div class="right">
            <a tal:attributes="href python:item.absolute_url() + '/view'">
              <img i18n:attributes="title" title="Info" src="pcng_info.gif"/></a>

            <tal:if tal:condition="python: 'TrackerAdmin' in member.getRolesInContext(here)">
               <a tal:attributes="href string:${here/absolute_url}/upload_remove?id=${item/getId}">
                 <img i18n:attributes="title" title="Delete file" src="delete.gif"/></a>
            </tal:if>
        </div>
        <div class="clear"> </div>

        <tal:if tal:condition="python: item.getId() != item.title_or_id()">
          <br> <!-- get rid of the BR -->
          <pre id="upload" tal:content="item/title_or_id" />
        </tal:if>
      </div>

      <div id="pcng_uploads" tal:condition="not: here/objectValues">
          <span i18n:translate="issue_artifacts_table_no_uploads_available">No uploads available</span>
      </div>
    </div>
  </div>
</div> 



<div metal:define-macro="issue_references_portlet" i18n:domain="plonecollectorng">
  <div class="portlet"
       tal:define="references here/getForwardReferences;
                   breferences here/getBackReferences" >


    <h5 i18n:translate="legend_references">References</h5>
    <div class="portletBody" id="pcng_portlet_references">

      <div id="pcng_references">
        <span id="label" i18n:translate="references">References</span>
        <ol>
          <li tal:repeat="ref references">
            <tal:def tal:define="target python: ref.getTargetObject()">
              <a tal:attributes="href target/absolute_url" tal:content="string: ${ref/collector_title|nothing}: ${target/title_or_id}"/>
              [<a tal:attributes="href string: delete_reference?issue_url=${ref/issue_url}">del</a>]
              <pre tal:content="ref/comment" />
            </tal:def>
          </li>
          <li tal:condition="not: references" i18n:translate="no_references">No references found</li>
        </ol>
      </div>

      <div id="pcng_references">
        <span id="label" i18n:translate="referenced_by">Referenced by</span>
        <ol>
          <li tal:repeat="ref breferences">
            <tal:def tal:define="source python: ref.getSourceObject()">
              <a tal:attributes="href source/absolute_url" tal:content="string: ${ref/collector_title|nothing}: ${source/title_or_id}"/>
              <pre tal:content="ref/comment" />
            </tal:def>
          </li>
          <li tal:condition="not: breferences" i18n:translate="no_references">No references found</li>
        </ol>
      </div>

      <div id="pcng_references">
        <span id="label"  i18n:translate="dependency_graph">Dependency graph</span>: 
        <ol>
          <li>
            <a href="pcng_references_tree?format=gif">[GIF]</a>
            <a href="pcng_references_tree?format=jpeg">[JPEG]</a>
            <a href="pcng_references_tree?format=png">[PNG]</a>
          </li>
        </ol>
      </div>
      
    </div> 
  </div> 
</div>  

</body>
</html>
