<metal:block metal:define-macro="collector_headline" i18n:domain="plonecollectorng">

  <h1 class="contentHeader"
      tal:condition="python: here.meta_type=='PloneCollectorNG'"
      tal:define="collector python: test(here.meta_type=='PloneIssueNG', here.aq_parent, here)">
    <img src="collector_icon.gif">
    <a tal:attributes="href collector/absolute_url" tal:content="collector/title_or_id" />
    <span tal:condition="collector/description"  tal:content="string:(${collector/description})" />
  </h1>

  <tal:if tal:condition="python: here.meta_type=='PloneIssueNG'" >
    <h2 class="contentHeader" >
      <img src="issue_icon.gif">
      <span tal:content="string:#${here/getId}: ${here/Title}" />
    </h2>
  </tal:if>

  <div>
    <div class="left" tal:condition="python: here.meta_type=='PloneIssueNG' and here.isPersistent()" >
      <a href=""
         class="link-parent"
         tal:attributes="href python: here.aq_parent.absolute_url()"
         i18n:translate="label_up_to_collector"
         tal:content="string:Up to the ${here/aq_parent/title_or_id} instance"
     />
    </div>
    <div class="left" tal:condition="exists:navig_configuration" >
      <a href="pcng_configuration"
         class="link-parent"
         i18n:translate="label_up_to_configuration"
         tal:content="string:Up to the configuration"
     />
    </div>
    <div class="right" id="pcng_headline" tal:condition="action|nothing">  
      <b>
          <span i18n:translate="" tal:content="string:${action}" />
          <tal:if tal:condition="request/fieldset|nothing">
              -- <span i18n:translate="" tal:content="request/fieldset" />
          </tal:if>
          (<span i18n:translate="" tal:content="python: here.pcng_user_role()" />)
      </b>
    </div>
    <div style="clear: both" ></div>
  </div>
</metal:block>

    
<metal:macro metal:define-macro="transcript_comments" i18n:domain="plonecollectorng">

  <tal:def tal:define="events python: [e for e in here.getTranscript().getEvents(types=['comment', 'upload', 'reference'], show_only=('private', 'public'))];
                    num_events python: len(events)">

    <div tal:condition="not: events" i18n:translate="no_entries">No entries</div>

    <div tal:repeat="event events">
      <div id="transcriptheader"> 
        #<span tal:content="python: num_events - repeat['event'].index" />:
         <span tal:content="python: here.toLocalizedTime(DateTime(event.getTimestamp()), long_format=1)" /> (<span tal:content="python: event.getUser()" />) 
         <span i18:translate="" tal:content="event/getType"/>/
         <span i18:translate="" tal:content="event/getState"/>/
         <span i18:translate="" tal:content="event/getLastStatus|nothing"/>
      </div>

      <div id="transcriptevent">
        <div tal:attributes="class event/getState">
          <div tal:content="structure python: here.pcng_format_event(event, 'html').encode(context.getSiteEncoding())" />
        </div>
        <div>
          <div class="right" tal:condition="python: event.getType() == 'comment'" id="pcng_transcript_actions">
            <a tal:attributes="href string:pcng_issue_followup?timestamp:float=${event/getTimestamp}">
              <img src="arrowRightmost.gif" title="Followup (with quoting this comment)" i18n:attributes="title">
            </a>
            <a tal:condition="python: member.has_permission('PloneCollectorNG: Edit PloneCollectorNG issue', here)"
               tal:attributes="href string:pcng_issue_transcript_edit?timestamp:float=${event/getTimestamp}">
               <img src="edit.gif" title="Edit this entry" i18n:attributes="title">
            </a>
    <!--
            <a tal:condition="python: member.has_permission('PloneCollectorNG: Manage PloneCollectorNG', here)"
               tal:attributes="href string:pcng_issue_transcript_delete?timestamp:float=${event/getTimestamp}">
               <img src="delete.gif" title="Delete this entry" i18n:attributes="title">
            </a>
    -->
          </div>
          <div class="clear"></div>
        </div>
        <br/>
      </div>
    </div> 
  </tal:def>
</metal:macro>

<metal:macro metal:define-macro="transcript_changes" i18n:domain="plonecollectorng">

  <tal:def tal:define="events python: here.getTranscript().getEvents(types=('change', 'incrementalchange'));
                       num_events python: len(events)">

    <div tal:condition="not: events" i18n:translate="no_entries">No entries</div>

    <table class="listing" id="table_transcript_changes">
      <tr tal:condition="events">
        <th i18n:translate="date">Date</th>
        <th i18n:translate="user">User</th>
        <th i18n:translate="event_type">Event type</th>
        <th i18n:translate="field">Field</th>
        <th i18n:translate="changes">Changes</th>
      </tr>

      <tal:loop tal:repeat="event events">
        <tr tal:attributes="class python: test(repeat['event'].even(), 'evenRow', 'oddRow')">
        <td class="pcng_top">
         <span tal:content="structure python: here.toLocalizedTime(DateTime(event.getTimestamp()), long_format=1).replace(' ', '&nbsp;')" /> 
        </td>
        <td class="pcng_top">
          <span i18n:translate="" tal:content="event/getUser" />
        </td>
        <td class="pcng_top">
          <span i18n:translate="" tal:content="event/getType" />
        </td>
        <td class="pcng_top" tal:content="event/getField|nothing"/>
        <td class="pcng_top">
          <div tal:content="structure python: here.pcng_format_event(event, 'html').encode(context.getSiteEncoding())" />
        </td>
      </tr>
      </tal:loop>
    </table>
  </tal:def>

</metal:macro>


<metal:div metal:define-macro="show_issues" i18n:domain="plonecollectorng">
  <tal:if tal:condition="python: context.getResults_representation() == 'list'">
    <div metal:use-macro="context/pcng_result_macros/macros/results" />
  </tal:if>
  <tal:if tal:condition="python: context.getResults_representation() == 'table'" >
    <div metal:use-macro="context/pcng_result_macros/macros/results2" />
  </tal:if>
</metal:div>    


<tal:macro metal:define-macro="search_issues_form" i18n:domain="plonecollectorng">
  <div>
  <form action="pcng_view" method="GET" name="search_form">
    <input type="hidden" name="advanced_search" value="1">

    <div id="pcng_searchform">
        <div tal:repeat="item here/pcng_catalog/getIndexes" style="float: left; margin-right: 5pt">
            <span id="label" i18n:translate="" tal:content="python: item[0]" />
            <div>
              <tal:if tal:condition="python: item[1] in ('FieldIndex','KeywordIndex')"
                      tal:define="displaylist python: here.pcng_vocabulary_values(item[0])">

                <select multiple size="5" 
                        tal:attributes="name python: '%s:list:%s' % (item[0], here.pcng_type_indexed_values(item[0]))">
                  <tal:loop tal:repeat="entry python: here.pcng_uniquevalsFor(item[0])" >
                    <option i18n:translate="" 
                            tal:attributes="value entry;
                                            SELECTED python: entry in request.get(item[0],[])" 
                            tal:content="python: displaylist.get(entry, entry)" />
                  </tal:loop>
                </select>
              </tal:if>
            </div>

            <tal:if tal:condition="python: item[1].find('TextIndex') > -1">
              <input type="text" tal:attributes="name python: item[0]" value="" size="30">
            </tal:if>
          </div>
        <div style="clear: both">&nbsp;</div> 
    </div>

    <div id="pcng_searchform">
      <span id="label" i18n:translate="fulltextsearch">Fulltext search</span>
      <div>
        <input type="text" name="SearchableText" value="" size="30" tal:attributes="value request/SearchableText|nothing">
      </div>
    </div>

    <div id="pcng_searchform">
      <span id="label" i18n:translate="search_by_date">Search by date</span>
      <div>
          <select name="datefield">
            <option i18n:translate=""
                    tal:repeat="item python: (
                          ('last_action', 'Last change'),
                          ('progress_deadline', 'Deadline'),
                          ('created', 'Created'))"
                    tal:attributes="value python: item[0];
                                    selected python: request.get('datefield', 'created') == item[0]"
                       tal:content="python: item[1]" />
          </select>
          <select name="datefield_direction">
            <option i18n:translate=""
                    tal:repeat="item python: (
                          ('since', 'since'),
                          ('until', 'until'))"
                    tal:attributes="value python: item[0];
                                    selected python: request.get('datefield_direction', 'since') == item[0]"
                       tal:content="python: item[1]" />
          </select>
          <input type="text" name="datefield_value" size="12"
                 tal:attributes="value python: request.get('datefield_value', '')">
          <span i18n:translate="days_or_date">Days or date</span>
      </div>
    </div>

    <div id="pcng_searchform">
      <span id="label" align="left" i18n:translate="sorting">Sorting</span>

      <div>
        <select name="sort_on" size="1">
          <option i18n:translate=""
                  tal:repeat="item python: (
                        ('getId','Issue'),
                        ('creation_date','Date'),
                        ('progress_deadline','Deadline'),
                        ('Creator','Submitter'),
                        ('progress','Progress'),
                        ('classification','Classification'),
                        ('status','Status'),
                        ('Title','Title') ,
                        ('topic','Topic'),
                        ('importance','Importance')
                        )"
                   tal:attributes="value python: item[0];
                                   selected python: request.get('sort_on', 'getId') == item[0]"
                   tal:content="python: item[1]" />
        </select> 

        <select name="sort_direction" size="1">
          <option i18n:translate=""
                  tal:repeat="item python: (
                        ('desc','Desc'),
                        ('asc','Asc'),
                        )"
                   tal:attributes="value python: item[0];
                                   selected python: request.get('sort_direction', 'desc') == item[0]"
                   tal:content="python: item[1]" />
        </select> 
      </div>
  </div>

  <div id="pcng_searchform">
      <span id="label" i18n:translate="hits_per_page">Hits per page</span>
      <div>
        <select name="batchsize:int" size="1">
          <option i18n:translate=""
                  tal:repeat="item python: (
                        (10,10),
                        (25,25),
                        (50,50),
                        (100,100),
                        (250,250),
                        (500,500)
                        )"
                   tal:attributes="value python: item[0];
                                   selected python: request.get('batchsize', 10) == item[0]"
                   tal:content="python: item[1]" />
        </select> 
      </div>

      <div id="pcng_searchform">
        <input type="submit" value="Search" i18n:attributes="value" class="standalone">
      </div>
    </div>


  </form>
  </div>
 
  <div id="pcng_searchform">
    <hr style="width: 100%">
    <div metal:use-macro="here/pcng_macros/macros/issue_statistics" />  
  </div>
</tal:macro>

<!-- display some issue statistics -->

<tal:macro metal:define-macro="issue_statistics">
  <div class="issue_statistics" style="list-style: none">
    <ul>
      <li style="display: inline">
        <span i18n:translate="statistics">Statistics</span>:
      </li>
      <li tal:repeat="state here/issue_states" style="display: inline">
        <a tal:attributes="href string:pcng_view?advanced_search:int=1&status=${state}">
          <span i18n:translate="" tal:content="state/capitalize" />
        </a>:
        <span tal:content="python: len(here.pcng_catalog.searchResults(status={'query' : state}))" />
        <span tal:condition="not: repeat/state/end" tal:omit-tag="">&bull;</span>
      </li>
    <ul>
  </div>
</tal:macro>

<!-- (C) footer -->

<tal:macro metal:define-macro="copyright">
  <div class="documentByLine">
  PloneCollectorNG (C) 2003-2004 by <a class="link-plain" href="http://www.zopyx.com/">ZOPYX - Software Development and Consulting Andreas Jung</a>
  </div>
</tal:macro>
