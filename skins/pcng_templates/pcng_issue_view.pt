<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US"
      lang="en-US"
      i18n:domain="plonecollectorng"
      metal:use-macro="here/main_template/macros/master">
  <body>

    <metal:block metal:fill-slot="head_slot">
	  <link rel="Stylesheet" type="text/css" tal:attributes="href string:$portal_url/pcng_styles.css" />
    </metal:block>

    <div metal:fill-slot="main">

      <!-- The evil in person -->
      <tal:call> 
        <span tal:define="dummy here/setDefaults" />
      </tal:call>

      <!-- set the view mode based on the collector preferences -->

      <metal:block tal:condition="not: request/mode|nothing">
        <metal:block tal:define="global mode python: member.getProperty('pcng_default_view') or 'simple'" />
      </metal:block>
      <metal:block tal:condition="request/mode|nothing">
        <metal:block tal:define="global mode request/mode" />
      </metal:block>
<span tal:content="mode" />

      <metal:block tal:define="action string: View">
        <span metal:use-macro="here/pcng_macros/macros/collector_headline" />
      </metal:block>

      <div style="clear: both"
           tal:define="canEdit python: member.has_permission('PloneCollectorNG: Edit PloneCollectorNG issue', here);
                       canFollowup python: member.has_permission('PloneCollectorNG: Add PloneCollectorNG issue followup' , here) ">

        <tal:loop tal:repeat="schemata_name python: here.atse_getSchemataNames()">
          <tal:if  tal:condition="python: schemata_name not in ('default',) "> 
            <div class="portlet" id="pcng_metadata"
                     tal:define="schemata python:here.atse_getSchemata(schemata_name);
                                 fields python: test(schemata_name=='issuedata', 
                                                [f for f in schemata.fields() if not f.getName() in ('title', 'description', 'solution')], 
                                                schemata.fields())">
              <h5>
                <span i18n:translate="" tal:content="schemata_name" />
                <a tal:condition="canEdit" tal:attributes="href string:pcng_base_edit?fieldset=${schemata_name}"><img src="edit.gif" title="Edit" i18n:attributes="title"/></a>
              </h5>
              <div class="portletBody" id="pcng_metadata_body">
                <div metal:use-macro="here/issue_macros/macros/view_schemata_as_div" />

                  <tal:if tal:condition="python: schemata_name == 'issuedata'" >
                    <span id="label" i18n:translate="status">Status</span>: 
                    <span class="field" i18n:translate="" tal:content="python: here.pcng_format_status(here.status())" />
                    <br>
                    <span id="label" i18n:translate="assigned_to">Assigned to</span>: 
                    <span class="field" tal:content="python: ', '.join(here.assigned_to(sorted=1))" />
                    <br>
                    <span id="label" i18n:translate="creator">Created by</span>: 
                    <span class="field" tal:content="here/Creator" />
                    <br>
                    <span id="label" i18n:translate="created_at">Created at</span>: 
                    <span class="field" tal:content="python: here.toLocalizedTime(here.CreationDate())" />
                  </tal:if>
              </div>
            </div>
          </tal:if>
        </tal:loop>

       </div>


      <div style="clear: both"  id="issue_description_solution"
           tal:define="schema python: here.atse_getSchemata('issuedata')">
        <tal:def tal:define="field python: schema['description']" >
          <div class="row" tal:condition="python: field and getattr(here, field.getName())" >
            <span id="label_large" i18n:translate="" tal:content="python: field.widget.Label(here).strip()" />:
            <pre class="issue_metadata"
                 tal:content="python: here.format_pre('description')" />
          </div>
        </tal:def>

        <tal:def tal:define="field python: schema['solution']" >
          <div class="row" tal:condition="python: field and getattr(here, field.getName())" >
            <span id="label_large" i18n:translate="" tal:content="python: field.widget.Label(here).strip()" />:
            <pre class="issue_metadata">
              <span metal:use-macro="python: here.widget(field.getName(), mode='view', use_label=0)"/>
            </pre>
          </div>
        </tal:def>
      </div>

      <div id="issue_transcript">
        <span id="label_large" i18n:translate="transcript">Transcript</span>
        <div metal:use-macro="here/pcng_macros/macros/transcript_plain" /> 
      </div>


      <fieldset tal:condition="python: mode == 'fullimages'" 
                tal:define="images python: here.objectValues(('Portal Image',))">
        <legend i18n:translate="images">Images</legend>
        <div tal:repeat="image images">
          <span tal:content="image/getId" />:<br/>
          <img tal:attributes="src image/absolute_url">
          <br/>
        </div>
        <div tal:condition="not: images">
          <span i18n:translate="no_images">No images available</span>
        </div> 
      </fieldset>

      <metal:block tal:condition="python: mode=='full'" >
        <div metal:use-macro="here/issue_macros/macros/watchlist" /> 
      </metal:block>

      <div class="documentByLine">
      PloneCollectorNG by <a class="link-plain" href="http://www.zopyx.com/">ZOPYX - Software development and Consulting Andreas Jung</a>
      </div>
    </div>
  </body>
</html>
