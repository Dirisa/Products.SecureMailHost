<metal:div metal:define-macro="selection">
  <div class="portlet">
    <h5 i18n:translate="selection">Registered Objects</h5>
    <div class="portletBody">
     <div style="margin: 5px 1px 5px 1px;">
         <form method="POST" tal:attributes="action string:${context/absolute_url}/atse_selectRegisteredSchema">
      <input type="hidden" name="schema_template" value="#"
             tal:attributes="value SCHEMA_TEMPLATE">
      <select name="selection:string">
        <span tal:repeat="item here/atse_getRegisteredSchemata">
          <option tal:attributes="value item;
                                  selected python: item == SCHEMA_ID"
                  tal:content="item" />
        </span>
      </select>
      <input type="submit" value="select" name="submit">
      </form>
    </div>
   </div>
  </div>
</metal:div>

<metal:div metal:define-macro="type">
    <span class="label" i18n:translate="type">Type</span>
    <div>
      <select name="fielddata.type:record:string"
              tal:attributes="onChange string:javascript:this.form.submit();;return true;;">
        <span tal:repeat="item field_types">
          <option tal:attributes="value item;
                                  selected python: item==here.atse_getFieldType(field)"
                  tal:content="item" />
        </span>
      </select>
    </div>

</metal:div>
            
<metal:div metal:define-macro="widget">

    <span class="label" i18n:translate="widget">Widget</span>
    <div>

      <select name="fielddata.widget:record:string"
                            tal:attributes="onChange string:javascript:this.form.submit();;return true;;">
        <tal:block tal:repeat="widget_info all_widget_info"
                   tal:omit-tag="python:1">
          <tal:data tal:define="widget_choice python:widget_info[1]['widget'];
                                widget_choice_id python:widget_info[0];
                                widget_choice_visible python:widget_info[1].get('visible', True);
                                widget_choice_format widget_choice/format | nothing;
                                widget_format python:getattr(field.widget, 'format', 0);
                                selected python:widget_name==widget_choice.getName() and test(widget_format, widget_format==widget_choice_format, 1)">
            <tal:selected tal:condition="selected">
              <tal:setselected tal:define="global selected_widget_key widget_choice_id;
                                           global selected_widget_data python:widget_info[1]" />
            </tal:selected>
            <option tal:content="widget_choice_id"
                    tal:attributes="value widget_choice_id;
                                    selected selected"
                    tal:condition="widget_choice_visible" />
          </tal:data>
        </tal:block>

      </select>
    </div>
</metal:div>

<metal:div metal:define-macro="row_col_size">
  <metal:block tal:condition="python: hasattr(widget, 'rows')">       
    <span i18n:translate="rows">Rows</span>
    <input type="text" size="3" name="fielddata.widgetrows:record:int" 
           tal:attributes="value widget/rows|string:10"/>
  </metal:block>
  <metal:block tal:condition="python: hasattr(widget, 'cols')">       
    <br>
    <span i18n:translate="cols">Cols</span>
    <input type="text" size="3" name="fielddata.widgetcols:record:int" 
           tal:attributes="value widget/cols|string:60"/>
  </metal:block>
</metal:div>

<metal:div metal:define-macro="size">
  <span class="label" i18n:translate="size">Size</span>
  <div>
    <metal:block tal:condition="python:selected_widget_data.has_key('size_macro')">
      <metal:block use-macro="python:path(selected_widget_data['size_macro'])" />
    </metal:block>

    <metal:block tal:condition="not: python:selected_widget_data.has_key('size_macro')">
      <span i18n:translate="size">Size</span>
      <input type="text" size="3" name="fielddata.widgetsize:record:int" 
             tal:attributes="value widget/size|string:60"/>
    </metal:block>
  </div>
</metal:div>

<metal:div metal:define-macro="maintenance">

  <div class="portlet">
    <h5 i18n:translate="maintenance">Maintenance</h5>
    <div class="portletBody" id="atse_maintenance">
      <div tal:condition="python: here.atse_editorCanUpdate(SCHEMA_ID)">
        <a href="#" 
	   tal:attributes="href string: ${here/absolute_url}/atse_updateManagedSchema?portal_type=$SCHEMA_ID&schema_template=$SCHEMA_TEMPLATE"
	   i18n:translate="update_schema_for_all_schemas">Update schema for all managed schemas</a>
      </div>
      <div tal:condition="python: not here.atse_editorCanUpdate(SCHEMA_ID)">
       <b>This schema is actually not configured to update its associated objects</b>
      </div>
      <br/>
      <div>
        <a href="#" 
           tal:attributes="href string: ${here/absolute_url}/atse_dump_schema?schema_id=$SCHEMA_ID"
           i18n:translate="update_schema_for_all_schemas">Dump schema</a>
      </div>
    </div>
  </div>

</metal:div>


<metal:div metal:define-macro="fieldsets">
  <div class="portlet" tal:condition="fieldsets">    <!-- Fieldsets -->
    <h5 i18n:translate="schematas">Schematas</h5>
    <div class="portletBody" id="atse_fieldsets">
      <div tal:repeat="set fieldsets">
        <div class="left">
           <a tal:content="string: ${set}" 
              tal:attributes="href string:${here/absolute_url}/$SCHEMA_TEMPLATE?schema_template=$SCHEMA_TEMPLATE&schema_id=$SCHEMA_ID&schemata=${set};
                             id python: test(set==fieldset, 'atse_selected', '')"/>
        </div>
        <div class="right">
            <a tal:attributes="href string:${context/absolute_url}/atse_schemataMoveLeft?schema_template=$SCHEMA_TEMPLATE&schema_id=$SCHEMA_ID&name=${set}"><img src="arrowUp.gif" title="Move up"></a> 
            <a tal:attributes="href string:${context/absolute_url}/atse_schemataMoveRight?schema_template=$SCHEMA_TEMPLATE&schema_id=$SCHEMA_ID&name=${set}"><img src="arrowDown.gif" title="Move down"></a> 
            <a tal:attributes="href string:${context/absolute_url}/atse_delSchemata?schema_template=$SCHEMA_TEMPLATE&schema_id=$SCHEMA_ID&name=${set}"><img src="delete.gif" title="Delete"></a> 
        </div>
        <div class="clear"> </div>
      </div>

      <div>
          <form tal:attributes="action string:${context/absolute_url}/atse_addSchemata" method="post">
         <input type="hidden" name="schema_id" tal:attributes="value SCHEMA_ID" />
         <input type="hidden" name="schema_template" tal:attributes="value SCHEMA_TEMPLATE" />
         <input type="text" name="name" value="" >
         <input type="image" src="add_icon.gif">
        </form>
      </div>
    </div>
  </div>
</metal:div>


<metal:div metal:define-macro="fields">
  <div class="portlet" tal:condition="fieldsets">    <!-- Fields -->
    <h5 i18n:translate="fields">Fields</h5>
    <div class="portletBody" id="atse_fields">  
      <div  tal:repeat="field python: here.atse_getSchemata(SCHEMA_ID, fieldset).fields()">
        <div class="left">
          <a tal:attributes="href string:${here/absolute_url}/$SCHEMA_TEMPLATE?schema_template=$SCHEMA_TEMPLATE&schema_id=$SCHEMA_ID&schemata=${fieldset}&field=${field/getName};
                             id python: test(field.getName() == request.get('field'), 'atse_selected', '')"
              tal:content="string: ${field/getName}" />
        </div>
        <div class="right">
            <a tal:attributes="href string:${context/absolute_url}/atse_fieldMoveLeft?schema_template=$SCHEMA_TEMPLATE&schema_id=$SCHEMA_ID&name=${field/getName}"><img src="arrowUp.gif" title="Move up"></a> 
                <a tal:attributes="href string:${context/absolute_url}/atse_fieldMoveRight?schema_template=$SCHEMA_TEMPLATE&schema_id=$SCHEMA_ID&name=${field/getName}"><img src="arrowDown.gif" title="Move down"></a> 
          <a tal:attributes="href string:${context/absolute_url}/atse_delField?schema_template=$SCHEMA_TEMPLATE&schema_id=$SCHEMA_ID&name=${field/getName}"><img src="delete.gif" title="Delete"></a> 
        </div>
        <div class="clear"> </div>
      </div>

      <div>
          <form tal:attributes="action string:${context/absolute_url}/atse_update" method="post">
          <input type="hidden" name="schema_id" tal:attributes="value SCHEMA_ID" />
          <input type="hidden" name="schema_template" tal:attributes="value SCHEMA_TEMPLATE" />
          <input type="hidden" name="fielddata.schemata:record:string"    
               tal:attributes="value fieldset" />
            <input type="hidden" name="add_field" value="dummy"> 
            <input type="text" name="name" value=""> 
            <input type="image" src="add_icon.gif" value="Add">
        </form>
      </div>
    </div>
  </div>
</metal:div>


<metal:div define-macro="vocabulary">
  <span class="label" i18n:translate="vocabulary">
    Vocabulary (Use "key|value" for passing key-value pairs 
    or 'method:&lt;methodname&gt;')
  </span>
  <div> 
    <textarea cols="60" rows="6"
              name="fielddata.vocabulary:record:lines"
              tal:content="python: here.atse_formatVocabulary(field)"></textarea>
  </div>
</metal:div>


<metal:div metal:define-macro="fieldeditor">

  <div class="portlet" id="atse_field_editor" tal:condition="request/field|nothing"> 
    <h5 i18n:translate="field_definition">Field definition for <b tal:content="request/field"/></h5>
    <div class="portletBody" id="atse_fieldeditor">

        <form tal:attributes="action string:${context/absolute_url}/atse_update" method="post"
            tal:define="field python: here.atse_getField(SCHEMA_ID, request['field']);
                        widget python: field.widget;
                        widget_name python:field.getWidgetName();
                        all_widget_info here/atse_getWidgetInfo;
                        all_widget_map here/atse_getWidgetMap;
                        field_types here/atse_getFieldTypes">
        <input type="hidden" name="schema_id" tal:attributes="value SCHEMA_ID" >
        <input type="hidden" name="schema_template" tal:attributes="value SCHEMA_TEMPLATE" />

        <input type="hidden" name="fielddata.name:record:string" 
               tal:attributes="value request/field|nothing" />
        <input type="hidden" name="fielddata.schemata:record:string"    
             tal:attributes="value fieldset" />
                                                                        
        <div>
          <div class="left">
             <tal:div metal:use-macro="here/atse_macros/macros/type" />         
           </div>
           <div class="left">
             <tal:div metal:use-macro="here/atse_macros/macros/widget" />         
           </div>
           <div class="left">
             <tal:div metal:use-macro="here/atse_macros/macros/size" />         
          </div>
          <div class="clear">&nbsp; </div>
     
        </div>
        <div class="clear"> </div>

        <div tal:condition="selected_widget_data/useVocab | nothing">
            <metal:block use-macro="here/atse_macros/macros/vocabulary" />
        </div>

        <div>
          <span class="label" i18n:translate="default">Default</span>
          <div>
            <input type="text" value="" size="60" 
                   name="fielddata.default:record:string"
                   tal:attributes="value python: here.atse_field_default(field)"/>
          </div>
        </div>

    	<br/>

        <div>
          <span class="label" i18n:translate="Validators">Validators</span>
          <div>
            <input type="text" value="" size="60" 
                   name="fielddata.validators:record:string"
                   tal:attributes="value python: ', '.join(getattr(field.widget, 'validators', ()))"/>
          </div>
        </div>

    	<br/>

        <div>
          <span class="label" i18n:translate="label">Label</span>
          <div>
            <input type="text" value="" size="60" 
                   name="fielddata.label:record:string"
                   tal:attributes="value python: field.widget.label"/>
          </div>
        </div>

        <div>
          <span class="label" i18n:translate="Description">Description</span>
          <div>
            <input type="text" value="" size="60" 
                   name="fielddata.description:record:string"
                   tal:attributes="value python: getattr(field.widget, 'description', '')"/>
          </div>
        </div>

        <div>
          <span class="label" i18n:translate="Help">Help</span>
          <div>
            <input type="text" value="" size="60" 
                   name="fielddata.help:record:string"
                   tal:attributes="value python: getattr(field.widget, 'help', '')"/>
          </div>
        </div>
      
        <div tal:condition="python: field.getType().split('.')[-1] == 'ReferenceField'">
          <br/>
          <span class="label" i18n:translate="label">Relationship</span>
          <div>
            <input type="text" value="" size="60" 
                   name="fielddata.relationship:record:string"
                   tal:attributes="value python: field.relationship"/>
          </div>
        </div>

        <br/>
        <div>
          <div class="left">
            <span class="label" i18n:translate="visible_edit">Visible (Edit)</span >
            <div>
              <input type="checkbox" value="visible" 
                     name="fielddata.visible_edit:record:string"
                     tal:attributes="checked python: here.atse_isFieldVisible(field.getName(), 'edit', SCHEMA_ID)"/>
            </div>
         </div>

          <div class="left">
            <span class="label" i18n:translate="required">Visible (View)</span >
            <div>
              <input type="checkbox" value="visible" 
                     name="fielddata.visible_view:record:string"
                     tal:attributes="checked python: here.atse_isFieldVisible(field.getName(), 'view', SCHEMA_ID)"/>
            </div>
         </div>

          <div class="left">
            <span class="label" i18n:translate="required">Required</span >
            <div>
              <input type="checkbox" value="1" 
                     name="fielddata.required:record:int"
                     tal:attributes="checked field/required"/>
            </div>
         </div>
        
          <div class="left">
            <span class="label" i18n:translate="create_index">Create index</span>
            <div>
              <input type="checkbox" value="1" 
                     name="fielddata.createindex:record:int"
                     tal:attributes="checked field/createindex|nothing"/>
            </div>
          </div>
          <div class="clear"> </div>
        </div>

        <metal:block tal:condition="python:selected_widget_data.has_key('post_macro')">
          <metal:block use-macro="python:path(selected_widget_data['post_macro'])" />
        </metal:block>
        
	<br/>
        <div> 
          <div class="field">
            <input type="submit" value="Save changes" class="standalone" i18n:attributes="value">
          </div> 
        </div>

      </form>
    </div>
  </div>
</metal:div>
