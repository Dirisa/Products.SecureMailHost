<metal:block metal:define-macro="field_quoted" i18n:domain="plonecollectorng">
  <span metal:use-macro="python: here.widget(request.get('fieldname'), mode='view', use_label=1)"/>
</metal:block>

<metal:block metal:define-macro="field_shortview" i18n:domain="plonecollectorng">
 <metal:block tal:define="value python: here.getParameter(field.getName())">
    <metal:block tal:condition="value">
     <span class="schemata_label" i18n:translate="" tal:content="python: field.widget.Label(here).strip()" />:
     <span tal:omit-tag="" tal:condition="not: field/vocabulary|nothing" tal:replace="value"/>
     <metal:block tal:condition="field/vocabulary|nothing" 
                  tal:define="vocab python: field.Vocabulary(here);
                              display python: here.displayValue(vocab, value)">
        <span tal:replace="structure display" />

     </metal:block>  
    </metal:block>
  </metal:block>
</metal:block>

<fieldset metal:define-macro="view_schemata" i18n:domain="plonecollectorng">
  <legend> <a class="schemata_legend"   
              tal:attributes="href string:pcng_base_edit?fieldset=${schemata_name}">
            <span i18n:translate="" tal:content="schemata_name"/>
           </a></legend>
  <metal:block  tal:repeat="field python: schemata.fields()">
    <span metal:use-macro="here/issue_macros/macros/field_shortview" /> &nbsp;&nbsp;
  </metal:block>
</fieldset>

<!-- Issue related macros -->

<div metal:define-macro="issue_references" i18n:domain="plonecollectorng">
  <fieldset tal:define="references here/getForwardReferences;
                        breferences here/getBackReferences" >


    <legend i18n:translate="legend_references">References</legend>

      <ul>

        <li><span i18n:translate="references">References</span>
          <ul>
            <li tal:repeat="ref references">
              <tal:def tal:define="target python: ref.getTargetObject()">
                <a tal:attributes="href target/absolute_url" tal:content="string: ${ref/collector_title|nothing}: ${target/title_or_id}"/>
                [<a tal:attributes="href string: delete_reference?issue_url=${ref/issue_url}">del</a>]
                <div tal:content="ref/comment" />
              </tal:def>
            </li>
             <li tal:condition="not: references" i18n:translate="no_references">No references found</li>
          </ul>
        </li>

        <li><span i18n:translate="referenced_by">Referenced by</span>
          <ul>
            <li tal:repeat="ref breferences">
              <tal:def tal:define="source python: ref.getSourceObject()">
                <a tal:attributes="href source/absolute_url" tal:content="string: ${ref/collector_title|nothing}: ${source/title_or_id}"/>
                <div tal:content="ref/comment" />
              </tal:def>
            </li>
            <li tal:condition="not: breferences" i18n:translate="no_references">No references found</li>
          </ul>
        </li>
        <li><span i18n:translate="dependency_graph">Dependency graph</span>: 
          <a href="pcng_references_tree?format=gif">[GIF]</a>
          <a href="pcng_references_tree?format=jpeg">[JPEG]</a>
          <a href="pcng_references_tree?format=png">[PNG]</a>
          <a href="pcng_references_tree?format=svg">[SVG]</a>
          <a href="pcng_references_tree?format=ps">[PS]</a>
        </li>
      </ul>
  </fieldset> 
</div>  


<fieldset metal:define-macro="issue_uploads" i18n:domain="plonecollectorng">
  <legend i18n:translate="uploads">Uploads</legend>
    <ul>
        <li tal:repeat="item here/objectValues">
            <span tal:define="icon item/getIcon|item/icon|nothing">

              <span tal:condition="icon">
                <img src="" alt="" border="0"
                     tal:attributes="src python: here.portal_url() + '/' + icon;
                                     alt item/Type|nothing" />
              </span>
              <a href="ITEM URL"
                 tal:attributes="href item/absolute_url"
                 tal:content="item/id">ITEM ID</a>

              <span tal:replace="python: '(%s, %s)' % (here.toPortalTime(item.created(),long_format=1), item.Creator())" />
              <a i18n:translate="issue_artifacts_table_info_link"
                 tal:attributes="href python:item.absolute_url() + '/view'">[Info]</a>

              <a tal:condition="python: 'TrackerAdmin' in member.getRolesInContext(here)"
                 i18n:translate="issue_artifacts_table_deletion_link"
                 tal:attributes="href string:${here/absolute_url}/upload_remove?id=${item/getId}">[Del]</a>
            </span>
             <span tal:replace="item/description"> DESCRIPTION</span>


      </li> <!-- End row -->
    <ul>
  <span i18n:translate="issue_artifacts_table_no_uploads_available"
        tal:condition="not: here/objectValues">No uploads available</span>

</fieldset> <!-- End group -->


<fieldset metal:define-macro="add_uploads" i18n:domain="plonecollectorng">
  <legend i18n:translate="legend_artifacts_upload">Upload files or images</legend>
    <form method="post" action="upload_file" enctype="multipart/form-data">

      <div class="row">
          <div class="label">&nbsp;</div>
          <div class="field"><input type="file" name="uploaded_file" size="40"/></div>
      </div> <!-- End row -->

       <div class="row">
        <div class="label" i18n:translate="add_artifacts_table_comment">Comment</div>
        <div class="field">
          <textarea name="comment" cols="60" rows="5"></textarea>
        </div>
       </div> <!-- End row -->

       <div class="row">
        <div class="field">
          <input type="submit" value="Upload" class="standalone" i18n:attributes="value">
        </div>
       </div> <!-- End row -->
  </form>
</fieldset> <!-- End group -->



<div metal:define-macro="add_references" i18n:domain="plonecollectorng">

<script language="javascript">
function show_tickets() {
    el = document.myform["reference.tracker:record:string"];
    selected = el.selectedIndex;

    if (selected == 0) {
        return 0;
    }

    tracker = el.options[selected].value;
    url = tracker + "/pcng_issue_selection"; 
    win = open(url, "tickets", "width=500, height=600, scrollbars=yes");
}

</script>

  <fieldset>

    <legend i18n:translate="legend_new_reference_to_issue">New reference to other issue</legend>
    <form method="post" action="add_reference" name="myform">

      <div class="row">
        <div class="label" i18n:translate="add_references_table_collector">
          Collector
        </div>
        <div class="field">
          <select name="reference.tracker:record:string">
            <option value="" />
            <metal:block tal:repeat="tracker python:here.superValues(('PloneCollectorNG',))">
              <option tal:attributes="value python: tracker.absolute_url(1);
                                      selected python: tracker.getId()==here.aq_parent.getId()"
                      tal:content="string: ${tracker/getId} (${tracker/title})" />

            </metal:block>
          </select>
        </div>
      </div> <!-- End row -->

      <div class="row">
        <div class="required_label" i18n:translate="add_references_table_issue_number">Issue #</div>
        <div class="field">
          <input type="text" name="reference.ticketnumber:record:string"  value="" size="5" />
          <input class="context" type="button"  onClick="javascript:show_tickets()" value="Select"
                 i18n:attributes="value" />
        </div>
      </div> <!-- End row -->

      <div class="row">
        <div class="required_label" i18n:translate="add_references_table_comment">
          Comment
        </div>
        <div class="field">
          <textarea  name="reference.comment:record:string" cols="60" rows="5"></textarea>
        </div>
      </div> <!-- End row -->

      <div class="row">
        <div class="field">
          <input type="submit" value="Submit" class="standalone" i18n:attributes="value">
        </div>
      </div> <!-- End row -->
    </form>
  </fieldset> <!-- End group -->
</div>  <!-- End macro: add_references_table -->


<div metal:define-macro="watchlist" i18n:domain="plonecollectorng">
  <fieldset tal:condition="python: here.wl_getMode()=='anonymous' or 
                                   (here.wl_getMode()=='authenticated' and member.getUserName() != 'Anonymous User') "
            tal:define="email python: member.getProperty('email')">

    <legend i18n:translate="legend_watchlist">Watchlist</legend>

    <metal:block tal:condition="email">
      <div tal:condition="not: python: here.wl_isWatcher(email)">
        <a tal:attributes="href string:${here/absolute_url}/wl_addWatcher?email=${email}"><span i18n:translate="watchlist_subscribe">Subscribe</span></a>
      </div>      
      <div tal:condition="python: here.wl_isWatcher(email)">
        <a tal:attributes="href string:${here/absolute_url}/wl_removeWatcher?email=${email}"><span i18n:translate="watchlist_unsubscribe">Unsubscribe</span></a>
      </div>      
    </metal:block>

    <metal:block tal:condition="not: email">
      <form tal:attributes="action string:${here/absolute_url}/wl_addWatcher">
        <span i18n:translate="email_address">E-Mail address</span>:        
        <input type="text" size="30" name="email" > &nbsp;
        <input type="submit" value="Subscribe to this issue" class="standalone" i18n:attributes="value">>
      </form>
    </metal:block>
  </fieldset>
</div>


