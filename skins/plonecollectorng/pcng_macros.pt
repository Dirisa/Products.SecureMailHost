<metal:block metal:define-macro="collector_headline" i18n:domain="plonecollectorng">

  <div class="collector_headline" tal:condition="python: here.meta_type=='PloneCollectorNG'" >
    <div>
      Collector: <a tal:attributes="href here/absolute_url" tal:content="here/title_or_id" />
      <span tal:condition="here/description"  tal:content="string:(${here/description})" />
    </div>
    <div style="font-size: 70%; " tal:condition="action|nothing"> 
      <span i18n:translate="" tal:content="string:${action}" />
      (<span i18n:translate="" tal:content="python: here.pcng_user_role()" />)
    </div>
  </div>

  <div class="collector_headline" tal:condition="python: here.meta_type=='PloneIssueNG'" >
    <div>
      Collector: <a tal:attributes="href python: here.aq_parent.absolute_url()" tal:content="python: here.aq_parent.title_or_id()" />:
      <span tal:content="string:#${here/getId}: ${here/Title}" />
    </div>
    <div style="font-size: 70%; " tal:condition="action|nothing"> 
      <span i18n:translate="" tal:content="string:${action}" />
      (<span i18n:translate="" tal:content="python: here.pcng_user_role()" />)
    </div>
    <div class="issue_view_navigation" tal:define="mode request/mode|nothing">
      <a tal:define="choosen python: mode =='simple'"  href="pcng_issue_view?mode=simple">
        <em tal:condition="choosen" i18n:translate="simpleview">Simple view</em> 
        <span tal:condition="not: choosen" i18n:translate="simpleview">Simple view</span> 
        &bull;
      </a> 
      <a tal:define="choosen python: mode == 'full'" href="pcng_issue_view?mode=full">
        <em tal:condition="choosen" i18n:translate="fullview">Full view </em> 
        <span tal:condition="not: choosen" i18n:translate="fullview">Full view </span> 
        &bull;
      </a> 
      <a tal:define="choosen python: mode == 'fullimages'" href="pcng_issue_view?mode=fullimages">
        <em tal:condition="choosen" i18n:translate="fullview_with_images">Full view with images</em> 
        <span tal:condition="not: choosen" i18n:translate="fullview_with_images">Full view with images</span> 
        &bull;
      </a> 
      <a tal:condition="here/haveReportlab" href="asPDF"><img src="pdflogo.gif" border="0" title="PDF"></a>
    </div>    
  </div>

</metal:block>

    
<div metal:define-macro="transcript_plain" i18n:domain="plonecollectorng">

  <span tal:define="groups python: here.getTranscript().getEventsGrouped();
                    num_groups python: len(groups)">

    <span tal:condition="not: groups" i18n:translate="no_entries">No entries</span>

    <span tal:repeat="events groups">
      <div class="transcriptheader">
        #<span tal:content="python: num_groups - repeat['events'].index" />:
         <span tal:content="python: here.toLocalizedTime(DateTime(events[0].getTimestamp()), long_format=1)" /> (<span tal:content="python: events[0].getUser()" />)
      </div>

      <metal:block tal:repeat="event events">
        <div class="transcriptevent">
          <tal:if tal:condition="python: event.getType()=='comment'">
            <pre tal:content="python: event.getValue('comment')"> kommentar</pre>
            <div style="text-align: right" >
              <a tal:attributes="href string:pcng_issue_followup?timestamp:float=${event/getTimestamp}">
                <span i18n:translate="followup_with_quote">Followup (with quoting this comment)</span>
              </a>
            </div>
          </tal:if>

          <span tal:condition="python: event.getType()=='change'">
           <b><span tal:content="python: event.getValue('field')" /></b>: "<span tal:content="python: event.getValue('old')" />" <b>-></b> 
                    "<span tal:content="python: event.getValue('new')" />"              
          </span>

          <span tal:condition="python: event.getType()=='incrementalchange'">
           <b><span tal:content="python: event.getValue('field')" /></b> <span i18n:translate="removed">removed</span>: <span tal:content="python: event.getValue('removed')" />, 
                    <span i18n:translate="added">added</span>: <span tal:content="python: event.getValue('added')" />              
          </span>

          <span tal:condition="python: event.getType()=='reference'"> 
            <span i18n:translate="issue_reference">Issue reference</span>:
            <a tal:attributes="href python: event.getValue('tracker') + '/' + event.getValue('ticketnum')"
               tal:content="python: '%s/%s: %s' % (event.getValue('tracker'), event.getValue('ticketnum'), event.getValue('comment'))" />
          </span>

          <span tal:condition="python: event.getType()=='upload'"><span i18n:translate="uploaded_file">Uploaded file</span>:
            <a tal:attributes="href python: event.getValue('fileid')"
               tal:content="python: event.getValue('fileid')" />
            <span tal:condition="python: event.getValue('comment')" tal:content="python: '(%s)' % event.getValue('comment')" />
          </span>
        </div>
      </metal:block>
      <br/>
    </span>
  </span>
</div>
    
<div metal:define-macro="transcript" i18n:domain="plonecollectorng">
  <table class="listing"
         tal:define="groups python: here.getTranscript().getEventsGrouped();
                     num_groups python: len(groups)">
    <tr>
      <th i18n:translate="transcript_time">Time</th>
      <th i18n:translate="transcript_user">User</th>
      <th i18n:translate="transcript_changes">Changes</th>
    </tr>

    <tr tal:repeat="events groups">
      <td valign="top" tal:content="python: here.toLocalizedTime(DateTime(events[0].getTimestamp()), long_format=1)" /> 
      <td valign="top" tal:content="python: events[0].getUser()" />

      <td valign="top">           
          <div class="transcriptevent"
               tal:repeat="event events" >

            <pre tal:condition="python: event.getType()=='comment'" tal:content="python: event.getValue('comment')" /> 

            <span tal:condition="python: event.getType()=='change'">
              <b><span tal:content="python: event.getValue('field')" /></b>: "<span tal:content="python: event.getValue('old')" />" <b>-></b> 
                       "<span tal:content="python: event.getValue('new')" />"              
            </span>
            <span tal:condition="python: event.getType()=='incrementalchange'">
              <b><span tal:content="python: event.getValue('field')" /></b> <span i18n:translate="removed">removed</span>: <span tal:content="python: event.getValue('removed')" />, 
                       <span i18n:translate="added">added</span>: <span tal:content="python: event.getValue('added')" />              
            </span>

            <span tal:condition="python: event.getType()=='reference'"> 
              <span i18n:translate="issue_reference">Issue reference</span>:
              <a tal:attributes="href python: event.getValue('tracker') + '/' + event.getValue('ticketnum')"
                 tal:content="python: '%s/%s: %s' % (event.getValue('tracker'), event.getValue('ticketnum'), event.getValue('comment'))" />
            </span>

            <span tal:condition="python: event.getType()=='upload'"> <span i18n:translate="uploaded_file">Uploaded file</span>:
              <a tal:attributes="href python: event.getValue('fileid')"
                 tal:content="python: event.getValue('fileid')" />
              <span tal:condition="python: event.getValue('comment')" tal:content="python: '(%s)' % event.getValue('comment')" />
           </span>
        </div>
      </td>
    </tr>
  </table>
 </div>
    

<div metal:define-macro="show_issues" i18n:domain="plonecollectorng">

  <span tal:define="results here/pcng_search_results; 
                    Batch python: modules['Products.CMFPlone'].Batch;
                    b_size python: request.get('batchsize', member.getProperty('pcng_hits_per_page', 10));
                    b_start python: 0;
                    b_start request/b_start|b_start;
                    have_reportlab here/haveReportlab">

    <div tal:condition="results" tal:define="batch python: Batch(results, b_size, int(b_start), orphan=0)">

      <div metal:use-macro="here/batch_macros/macros/navigation" />

      <metal:block tal:repeat="issue batch">
        <metal:block>
          <h2 class="pcng_transcript"> 
             <a tal:attributes="href string:${issue/getURL}/pcng_issue_view">
              <span tal:replace="issue/getId" />.
              <span tal:replace="issue/Title" />
            </a>
          <a tal:condition="have_reportlab" tal:attributes="href string:${issue/getURL}/asPDF"><img src="pdflogo_small.gif"  height="14" width="18" border="0" title="PDF"></a>
          </h2>
        </metal:block>
        <div class="pcng_issueview_metadata">
         <b i18n:translate="followups"># Followups</b>: <span tal:content="issue/numberFollowups" /> &bull; 
         <b i18n:translate="status">Status</b>: <span i18n:translate="" tal:content="python: here.pcng_format_status(issue.status)" /> &bull; 
         <b i18n:translate="topic">Topic</b>: <span tal:replace="issue/topic" /> &bull;
         <b i18n:translate="importance">Importance</b>:
         <metal:block tal:define="field python: here.atse_getSchema()['importance'];
                                  vocab python: field.Vocabulary(here);
                                  display python: here.displayValue(vocab, issue.importance)">
            <span tal:content="structure display" />
         </metal:block> &bull;
         <b i18n:translate="assigned">Assigned</b>: <span tal:replace="python: ', '.join(issue.assigned_to)" />
        </div>
        <div class="pcng_issueview_description" 
             tal:content="python: here.shorten_string(issue.Description, maxlength=180)" />

        <div class="pcng_issueview_legend">
          <span i18n:translate="submitted_by">Submitted by</span> <span tal:replace="issue/Creator" /> on <span tal:replace="python: here.toLocalizedTime(issue.created)" /> &bull; 
          <span i18n:translate="last_modified">Last modified:</span> <span tal:replace="python: here.toLocalizedTime(issue.modified)" />
          (<span tal:replace="python: '%.1f' % (DateTime() - issue.modified)" />
          <span i18n:translate="days_ago">days ago</span>)

        </div>
      </metal:block>
      <div metal:use-macro="here/batch_macros/macros/navigation" />
    </div>
    <div tal:condition="not: results" i18n:translate="no_issues_found">No issues found</div>
  </span>
</div>    


<tal:macro metal:define-macro="search_issues_form" i18n:domain="plonecollectorng"

 tal:define="advanced python: int(int(request.get('advanced_search', 0)) == 1 or member.getProperty('pcng_default_searchform') == 'advanced')">

  <div style="float: left">

    <div style="float: left">
      <form  method="post" tal:attributes="action string: ${here/absolute_url}/pcng_show_issue">
        <span i18n:translate="jump_to_ticket">Jump to issue number </span> 
        <input type="text" name="issuenumber" size="5" /> &nbsp;
        <input type="submit" value=" Jump " i18n:attributes="value" class="standalone"/>
      </form>
    </div>

    <div style="float: right" tal:condition="python: member.getUserName() != 'Anonymous User'">

      <div style="text-align: right">
        <form method="post" action="pcng_do_search">
          <span i18n:translate="my_saved_searches">My saved searches</span>:

          <!-- saved searches are stored as a list of string 'RELATIVE_URL::query_id::QUERY_STRING' -->

          <select name="query">
            <tal:loop tal:repeat="saved_search python: [s for s in member.getProperty('pcng_saved_searches', []) if s.startswith(here.absolute_url(1))]" >
              <option tal:content="python: saved_search.split('::', 2)[1]" 
                      tal:attributes="value python: saved_search.split('::', 2)[2]"
                  />

            </tal:loop>
          </select>
          <input type="submit" value="Search" i18n:attributes="value" class="standalone"/>
        </form>    
      </div>

      <div tal:condition="advanced" style="text-align: right">
        <form method="post" action="pcng_save_search">
          <input type="hidden" name="query" tal:attributes="value request/QUERY_STRING">
          <span i18n:translate="save_this_search_as">Save search as</span>:
          <input type="text" name="query_id" value="" size="20" maxlength="20">
          <input type="submit" value="Save" i18n:attributes="value" class="standalone" />
          </form>    
      </div>

      <div tal:condition="python: member.getUserName() != 'Anonymous User'" style="text-align: right">
        <a tal:attributes="href string:pcng_view?filter=assigned&advanced_search=${advanced}"><span i18n:translate="issues_assigned_to_me">Issues assigned to me</span></a> &bull; 
        <a tal:attributes="href string:pcng_view?filter=submitted&advanced_search=${advanced}"><span i18n:translate="issues_submitted_by_me">Issues submitted by me</span></a>
      </div>

    </div>
  </div>

  <div style="float: left">
    <a href="pcng_view?advanced_search=1" tal:condition="not: advanced"><span i18n:translate="advanced_search">Advanced search</span></a>
  </div>

  <div style="float: left">
  <br>
  <form action="pcng_view" method="GET" name="search_form" tal:condition="advanced">
    <div style="float: left">

      <input type="hidden" name="advanced_search" value="1">

      <div>
        <tal:loop tal:repeat="item here/getIndexes">
          <div style="float: left; margin: 5pt">
            <span class="label" i18n:translate="" tal:content="python: item[0]" />
            <br>
            <tal:if tal:condition="python: item[1] in ('FieldIndex','KeywordIndex')">
              <select multiple size="5" 
                      tal:attributes="name python: '%s:%s' % (item[0], here.pcng_type_indexed_values(item[0]))">
                <tal:loop tal:repeat="entry python: here.pcng_uniquevalsFor(item[0])" >
                  <option i18n:translate="" tal:attributes="value entry;
                                          selected python: request.get(item[0],'')==entry" 
                         tal:content="entry" />
                </tal:loop>
              </select>
            </tal:if>

            <tal:if tal:condition="python: item[1].find('TextIndex') > -1">
              <input type="text" tal:attributes="name python: item[0]" value="" size="30">
            </tal:if>
          </div>
        </tal:loop>
        <div style="float: right"></div>
      </div>
    </div>


    <div style="float: left">
      <div>
        <span class="label" i18n:translate="fulltextsearch">Fulltext search</span>
        <br/>
        <input type="text" name="SearchableText" value="" size="30" tal:attributes="value request/SearchableText|nothing">
      </div>

      <div>
        <span class="label" align="left" i18n:translate="sorting">Sorting</span>

        <div>
          <select name="sort_on" size="1">
            <option i18n:translate=""
                    tal:repeat="item python: (
                          ('getId','Issue'),
                          ('creation_date','Date'),
                          ('progress_deadline','Deadline'),
                          ('Creator','Submitter'),
                          ('progress','Progress'),
                          ('classification','Classification'),
                          ('status','Status'),
                          ('Title','Title') ,
                          ('topic','Topic'),
                          ('importance','Importance')
                          )"
                     tal:attributes="value python: item[0];
                                     selected python: request.get('sort_on', 'getId') == item[0]"
                     tal:content="python: item[1]" />
          </select> 

          <select name="sort_direction" size="1">
            <option i18n:translate=""
                    tal:repeat="item python: (
                          ('desc','Desc'),
                          ('asc','Asc'),
                          )"
                     tal:attributes="value python: item[0];
                                     selected python: request.get('sort_direction', 'desc') == item[0]"
                     tal:content="python: item[1]" />
          </select> 
        </div>
            
        <span class="label" i18n:translate="hits_per_page">Hits per page</span>

        <div>
          <select name="batchsize:int" size="1">
            <option i18n:translate=""
                    tal:repeat="item python: (
                          (10,10),
                          (25,25),
                          (50,50),
                          (100,100),
                          (250,250),
                          (500,500)
                          )"
                     tal:attributes="value python: item[0];
                                     selected python: request.get('batchsize', 10) == item[0]"
                     tal:content="python: item[1]" />
          </select> 
        </div>

      </div>
      <br>
      <div style="float: left">
        <input type="submit" value="Search" i18n:attributes="value" class="standalone">
      </div>
    </div>

  </form>
  </div>

  <div style="float: left">
    <tal:if tal:condition="advanced">
      <hr style="width: 100%">
      <div metal:use-macro="here/pcng_macros/macros/issue_statistics" />  
    </tal:if>
  </div>
</tal:macro>

<!-- display some issue statistics -->

<tal:macro metal:define-macro="issue_statistics">
  <div class="issue_statistics" style="list-style: none">
    <ul>
      <li style="display: inline">
        <span i18n:translate="statistics">Statistics</span>:
      </li>
      <li tal:repeat="state here/issue_states" style="display: inline">
        <span i18n:translate="" tal:content="state/capitalize" />:
        <span tal:content="python: len(here.pcng_catalog.searchResults(status={'query' : state}))" />
        <span tal:condition="not: repeat/state/end" tal:omit-tag="">&bull;</span>
      </li>
    <ul>
  </div>
</tal:macro>

