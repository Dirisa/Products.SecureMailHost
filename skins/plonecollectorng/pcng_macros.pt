    
<div metal:define-macro="transcript_plain">
  
  <span tal:define="groups python: here.getTranscript().getEventsGrouped();
                    num_groups python: len(groups)">

    <span tal:repeat="events groups">
      <div class="transcriptheader">
        #<span tal:content="python: num_groups - repeat['events'].index" />:
         <span tal:content="python: here.toPortalTime(DateTime(events[0].getTimestamp()), long_format=1)" /> (<span tal:content="python: events[0].getUser()" />)
      </div>

      <metal:block tal:repeat="event events">
        <div class="transcriptevent">
          <pre tal:condition="python: event.getType()=='comment'" tal:content="python: event.getValue('comment')"> kommentar
          </pre>

          <span tal:condition="python: event.getType()=='change'">
           <b><span tal:content="python: event.getValue('field')" /></b>: "<span tal:content="python: event.getValue('old')" />" <b>-></b> 
                    "<span tal:content="python: event.getValue('new')" />"              
          </span>

          <span tal:condition="python: event.getType()=='incrementalchange'">
           <b><span tal:content="python: event.getValue('field')" /></b> <span i18n:translate="removed">removed</span>: <span tal:content="python: event.getValue('removed')" />, 
                    <span i18n:translate="added">added</span>: <span tal:content="python: event.getValue('added')" />              
          </span>

          <span tal:condition="python: event.getType()=='reference'"> 
            <span i18n:translate="issue_reference">Issue reference</span>:
            <a tal:attributes="href python: event.getValue('tracker') + '/' + event.getValue('ticketnum')"
               tal:content="python: '%s/%s: %s' % (event.getValue('tracker'), event.getValue('ticketnum'), event.getValue('comment'))" />
          </span>

          <span tal:condition="python: event.getType()=='upload'"><span i18n:translate="uploaded_file">Uploaded file</span>:
            <a tal:attributes="href python: event.getValue('fileid')"
               tal:content="python: event.getValue('fileid')" />
            <span tal:condition="python: event.getValue('comment')" tal:content="python: '(%s)' % event.getValue('comment')" />
          </span>
        </div>
      </metal:block>
      <br/>
    </span>
  </span>
</div>
    
<div metal:define-macro="transcript">
  <table class="listing"
         tal:define="groups python: here.getTranscript().getEventsGrouped();
                     num_groups python: len(groups)">
    <tr>
      <th i18n:translate="transcript_time">Time</th>
      <th i18n:translate="transcript_user">User</th>
      <th i18n:translate="transcript_changes">Changes</th>

    </tr>

    <tr tal:repeat="events groups">
      <td valign="top" tal:content="python: here.toPortalTime(DateTime(events[0].getTimestamp()), long_format=1)" /> 
      <td valign="top" tal:content="python: events[0].getUser()" />

      <td valign="top">           
          <div class="transcriptevent"
               tal:repeat="event events" >

            <pre tal:condition="python: event.getType()=='comment'" tal:content="python: event.getValue('comment')" /> 

            <span tal:condition="python: event.getType()=='change'">
              <b><span tal:content="python: event.getValue('field')" /></b>: "<span tal:content="python: event.getValue('old')" />" <b>-></b> 
                       "<span tal:content="python: event.getValue('new')" />"              
            </span>
            <span tal:condition="python: event.getType()=='incrementalchange'">
              <b><span tal:content="python: event.getValue('field')" /></b> <span i18n:translate="removed">removed</span>: <span tal:content="python: event.getValue('removed')" />, 
                       <span i18n:translate="added">added</span>: <span tal:content="python: event.getValue('added')" />              
            </span>

            <span tal:condition="python: event.getType()=='reference'"> 
              <span i18n:translate="issue_reference">Issue reference</span>:
              <a tal:attributes="href python: event.getValue('tracker') + '/' + event.getValue('ticketnum')"
                 tal:content="python: '%s/%s: %s' % (event.getValue('tracker'), event.getValue('ticketnum'), event.getValue('comment'))" />
            </span>

            <span tal:condition="python: event.getType()=='upload'"> <span i18n:translate="uploaded_file">Uploaded file</span>:
              <a tal:attributes="href python: event.getValue('fileid')"
                 tal:content="python: event.getValue('fileid')" />
              <span tal:condition="python: event.getValue('comment')" tal:content="python: '(%s)' % event.getValue('comment')" />
           </span>
        </div>
      </td>
    </tr>
  </table>
 </div>
    

<div metal:define-macro="show_issues">

  <span tal:define="results here/pcng_search_results; 
                    Batch python: modules['Products.CMFPlone'].Batch;
                    b_size python: 10;
                    b_start python: 0;
                    b_start request/b_start|b_start">

    <div tal:condition="results" tal:define="batch python: Batch(results, b_size, int(b_start), orphan=0)">
      <div metal:use-macro="here/batch_macros/macros/navigation" />

      <metal:block tal:repeat="issue batch">
        <h2 class="pcng_transcript">       
          <a tal:attributes="href python: here.absolute_url() + '/' + issue.getId">
            <span tal:replace="issue/getId" />.
            <span tal:replace="issue/Title" />
          </a>
        </h2>
        <div class="pcng_issueview_metadata">
         <b i18n:translate="status">Status:</b> <span tal:replace="python: here.pcng_format_status(issue.status)" /> - 
         <b i18n:translate="topic">Topic:</b> <span tal:replace="issue/topic" /> -
         <b i18n:translate="importance">Importance:</b> <span tal:replace="issue/importance" /> -
         <b i18n:translate="assigned">Assigned:</b> <span tal:replace="python: ', '.join(issue.assigned_to)" />
        </div>
        <div class="pcng_issueview_description" 
             tal:content="python: here.shorten_string(issue.Description, maxlength=180)" />

        <div class="pcng_issueview_legend">
        <span i18n:translate="submitted_by">Submitted by</span> <span tal:replace="issue/Creator" /> on <span tal:replace="python: here.toPortalTime(issue.created)" />
        </div>
      </metal:block>
    </div>
    <div tal:condition="not: results" i18n:translate="no_hits">No hits</div>
  </span>
</div>    


<div metal:define-macro="search_issues_form">

  <a href="?advanced_search=1"
     tal:condition="not: request/advanced_search|nothing">Advanced search</a>

  <form  method="post" tal:attributes="action string: ${here/absolute_url}/pcng_show_issue">
    <span i18n:translate="jump_to_ticket">Jump to issue number </span> 
    <input type="text" name="issuenumber" size="5" /> &nbsp;
    <input type="submit" value=" Jump " i18n:attributes="value" class="standalone"/>
  </form>

        
  <form action="pcng_view" method="post"  name="search_form" tal:condition="request/advanced_search|nothing">
    <input type="hidden" name="advanced_search" value="1">
    <table>
      <tr>
        <th align="center" i18n:translate="heading_status"> Status </th>
        <th align="center" i18n:translate="heading_requester">Requester</th>
        <th align="center" i18n:translate="heading_assigned">Assigned </th>
        <th align="center" i18n:translate="heading_assigned">Importance</th>
        <th align="center" i18n:translate="heading_assigned">Topic</th>
        <th></th>
        <th colspan="2" i18n:translate="sorting"> Sorting </th>
      </tr>

      <tr>
        <td align="center">
          <select name="status:list:ignore_empty" 
                  multiple 
                  size="5"
                  tal:define="values here/issue_states">
            <option tal:repeat="status values"
                    i18n:translate=""
                    tal:attributes="value status;
                                    selected python: status in request.get('status', [])"
                    tal:content="status" />
          </select>
        </td>

        <td align="center">
          <select name="Creator:list:ignore_empty"      
                  multiple 
                  size="5"
                  tal:define="values python: here.pcng_uniquevalsFor('Creator')">
              
            <option tal:repeat="creator values"
                    tal:attributes="value creator;
                                    selected python: creator in request.get('Creator', [])"
                    tal:content="creator" />
          </select>
        </td>

        <td align="center">
          <select name="assigned_to:list:ignore_empty"      
                  multiple 
                  size="5"
                  tal:define="values python: here.pcng_uniquevalsFor('assigned_to')" >
              
            <option tal:repeat="assignee values"
                    tal:attributes="value assignee;
                                    selected python: assignee in request.get('assigned_to', [])"
                    tal:content="assignee" />
          </select>
        </td>

        <td align="center">
          <select name="importance:list:ignore_empty"      
                  multiple 
                  size="5"
                  tal:define="values python: here.pcng_uniquevalsFor('importance')" >
              
            <option tal:repeat="item values"
                    tal:attributes="value item;
                                    selected python: item in request.get('importance', [])"
                    tal:content="item" />
          </select>
        </td>

        <td align="center">
          <select name="topic:list:ignore_empty"      
                  multiple 
                  size="5"
                  tal:define="values python: here.pcng_uniquevalsFor('topic')" >
              
            <option tal:repeat="item values"
                    tal:attributes="value item;
                                    selected python: item in request.get('topic', [])"
                    tal:content="item" />
          </select>
        </td>

        <td> &nbsp</td>

        <td align="center" valign="top">
          <select name="sort_on" size="5">
            <option i18n:translate=""
                    tal:repeat="item python: (
                          ('getId','Issue'),
                          ('creation_date','Date'),
                          ('progress_deadline','Deadline'),
                          ('Creator','Submitter'),
                          ('progress','Progress'),
                          ('classification','Classification'),
                          ('status','Status'),
                          ('Title','Title') ,
                          ('topic','Topic'),
                          ('importance','Importance')
                          )"
                     tal:attributes="value python: item[0];
                                     selected python: request.get('sort_on', 'getId') == item[0]"
                     tal:content="python: item[1]" />
          </select> 
        </td>

        <td align="center" valign="top">
          <select name="sort_direction" size="2">
            <option i18n:translate=""
                    tal:repeat="item python: (
                          ('desc','Desc'),
                          ('asc','Asc'),
                          )"
                     tal:attributes="value python: item[0];
                                     selected python: request.get('sort_direction', 'desc') == item[0]"
                     tal:content="python: item[1]" />
          </select> 
        </td>
      </tr>
 
      <tr>
        <td colspan="4">
          <span i18n:translate="fulltextsearch">Fulltext search</span>
          <input type="text" name="SearchableText" value="" size="40">
        </td>
      </tr>

      <tr>
        <td colspan="2">
          <input type="submit" value=" Search " class="standalone">
        </td>
      </tr>
    
    </table>
  </form>
</div>
