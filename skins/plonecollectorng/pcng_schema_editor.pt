<html xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="plonecollectorng">

<body>
  <div metal:fill-slot="main">

    <h1 i18n:translate="heading_edit_schema">Schema editor</h1>

    <table border="1" cellspacing="4" cellpadding="2"
           td tal:define="fieldsets python:[key for key in here.schema_getNames() if not key in ['metadata', 'default']];
                          default_fieldset python: fieldsets[0];
                          fieldset request/fieldset|default_fieldset; ">
      <metal:block tal:condition="not: request/fieldset|nothing">
        <span tal:define="dummy python: request.set('fieldset', fieldsets[0])" /> 
      </metal:block>

      <tr>
        <th>Schemata</th>
        <th>Field definition</th>
      </tr>

      <tr>
        <td valign="top">
          <div tal:condition="fieldsets">  <!-- Navigation -->
            <form action="schema_newSchema" method="post">
              <tal:block repeat="set fieldsets">
                <div tal:condition="python: set == fieldset">
                  <b tal:content="string: ${set}" />
                    <a tal:attributes="href string:schema_moveLeft?fieldset=${fieldset}"><img src="arrowUp.gif" title="Move up"></a> 
                    <a tal:attributes="href string:schema_moveRight?fieldset=${fieldset}"><img src="arrowDown.gif" title="Move down"></a> 
                    <a tal:attributes="href string:schema_delSchema?fieldset=${fieldset}"><img src="delete.gif" title="Delete"></a> 
                  <ul>
                    <metal:block tal:repeat="field python: here.schema_getSchema(fieldset).fields()">
                      <li> 
                        <metal:block tal:condition="python: field.getName() == request.get('field')">
                          <a href="#" tal:attributes="href string:${here/absolute_url}/portal_form/pcng_schema_editor?fieldset=${set}&field=${field/getName}">
                            <b tal:content="string: ${field/getName}"/></a>
                          <a tal:attributes="href string:schema_field_up?fieldset=${fieldset}&name=${field/getName}"><img src="arrowUp.gif" title="Move up"></a> 
                          <a tal:attributes="href string:schema_field_down?fieldset=${fieldset}&name=${field/getName}"><img src="arrowDown.gif" title="Move down"></a> 
                          <a tal:attributes="href string:schema_del_field?fieldset=${fieldset}&name=${field/getName}"><img src="delete.gif" title="Delete"></a> 
                        </metal:block>
                          <metal:block tal:condition="not: python: field.getName() == request.get('field')">
                            <a href="#" tal:attributes="href string:${here/absolute_url}/portal_form/pcng_schema_editor?fieldset=${set}&field=${field/getName}">
                              <span tal:content="string: ${field/getName}" /></a>
                        </metal:block>
                      </li>
                    </metal:block>
                  </ul>
                </div>
                <div tal:condition="python: set != fieldset">
                  <a href="#" tal:attributes="href string:${here/absolute_url}/portal_form/pcng_schema_editor?fieldset=${set}"
                     tal:content="string: ${set}" />
                </div>
              </tal:block>
              <hr/>
              <div class="row"> 
                <input type="text" name="fieldset" value="" size="15">
                <input type="submit" value=" Add new schemata"  class="standalone">
              </div>
            </form>
            <a href="update_schema_for_issues?return_to=pcng_schema_editor">Update schema for all issues</a>
          </div>
        </td>  <!-- EOF Navigation -->

        <td valign="top" tal:condition="request/field|nothing">  <!-- field editor -->

          <form action="schema_update" method="post"
                tal:define="field python: here.schema_getSchema(fieldset)[request['field']]">
            <input type="hidden" name="fielddata.name:record:string" 
                   tal:attributes="value request/field|nothing" />
            <input type="hidden" name="fielddata.schemata:record:string"    
                   tal:attributes="value request/fieldset|nothing" />


            <div class="row">
              <div class="label">Name</div>
              <div class="field">
                <span tal:content="field/getName" />
              </div>
            </div>

            <div class="row">
              <div class="label">Type</div>
              <div class="field">
                <select name="fielddata.type:record:string">
                  <span tal:repeat="item python: ('StringField', 'IntegerField', 'FloatField', 'FixedPointField', 'LinesField', 'DateTimeField', 'BooleanField')">
                    <option tal:attributes="value item;
                                            selected python: item==here.schema_get_fieldtype(field)"
                            tal:content="item" />
                  </span>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="label">Widget</div>
              <div class="field">
                <select name="fielddata.widget:record:string">
                  <option value="String" 
                          tal:content="string:String"
                          tal:attributes="selected python: field.getWidgetName()=='StringWidget'" />
                  <option value="Textarea" 
                          tal:content="string:Textarea"
                          tal:attributes="selected python: field.getWidgetName()=='TextAreaWidget'" />
                  <option value="Radio" 
                          tal:content="string:Radio"
                          tal:attributes="selected python: field.getWidgetName()=='SelectionWidget' and field.widget.format=='radio'"/>
                  <option value="Select" 
                          tal:content="string:Select"
                          tal:attributes="selected python: field.getWidgetName()=='SelectionWidget' and field.widget.format=='select'"/>
                  <option value="Flex" 
                          tal:content="string:flexible Selection"
                          tal:attributes="selected python: field.getWidgetName()=='SelectionWidget' and field.widget.format=='flex'"/>
                  <option value="Lines" 
                          tal:content="string:Lines"
                          tal:attributes="selected python: field.getWidgetName()=='LinesWidget' "/>
                  <option value="Calendar" 
                          tal:content="string:Calendar"
                          tal:attributes="selected python: field.getWidgetName()=='CalendarWidget' "/>
                  <option value="Boolean" 
                          tal:content="string:Boolean"
                          tal:attributes="selected python: field.getWidgetName()=='BooleanWidget' "/>
                  <option value="MultiSelect" 
                          tal:content="string:MultiSelect"
                          tal:attributes="selected python: field.getWidgetName()=='MultiSelectionWidget' "/>
                  <option value="Keywords" 
                          tal:content="string:Keywords"
                          tal:attributes="selected python: field.getWidgetName()=='KeywordWidget' "/>
                  <option value="Richtext" 
                          tal:content="string:Richtext"
                          tal:attributes="selected python: field.getWidgetName()=='RichWidget' "/>
                  <option value="Password" 
                          tal:content="string:Password"
                          tal:attributes="selected python: field.getWidgetName()=='PasswordWidget' "/>
                  <option value="Visual" 
                          tal:content="string:Visual"
                          tal:attributes="selected python: field.getWidgetName()=='VisualWidget' "/>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="label">Size (Use "ROWSxCOLS" for Textarea or Line widgets)</div>
                
              <div class="field">
                <input type="text" value="20" size="10" name="fielddata.widgetsize:record:string"/>
              </div>
            </div>

            <div class="row" tal:condition="python: field.getWidgetName() in ('MultiSelectionWidget', 'SelectionWidget')">
              <div class="label">Vocabulary (Use "key|value" for passing key-value pairs or 'method:&lt;methodname&gt;')</div>
              <div class="field">
                <textarea cols="60" rows="6"
                       name="fielddata.vocabulary:record:lines"
                       tal:condition="python: field.getWidgetName() in ('MultiSelectionWidget', 'SelectionWidget')"
                       tal:content="python: here.schema_format_vocabulary(field)"></textarea>
              </div>
            </div>

            <div class="row">
              <div class="label">Default</div>
              <div class="field">
                <input type="text" value="" size="40" 
                       name="fielddata.default:record:string"
                       tal:attributes="value field/getDefault"/>
              </div>
            </div>

            <div class="row">
              <div class="label">Label</div>
              <div class="field">
                <input type="text" value="" size="40" 
                       name="fielddata.label:record:string"
                       tal:attributes="value python: field.widget.label"/>
              </div>
            </div>

            <div class="row">
              <div class="label">Required</div>
              <div class="field">
                <input type="checkbox" value="1" 
                       name="fielddata.required:record:int"
                       tal:attributes="checked field/required"/>
              </div>
            </div>

            <div class="row">
              <div class="label">Invisible</div>
              <div class="field">
                <input type="checkbox" value="1" 
                       name="fielddata.invisible:record:int" 
                       tal:attributes="checked python: field.widget.visible == 0"/>
              </div>
            </div>

            <div class="row">
              <div class="field">
                <input type="submit" value=" Save changes" class="standalone">
              </div> 
            </div>
          </form>

          <form action="schema_update" method="post">
            <input type="hidden" name="fielddata.schemata:record:string"    
                   tal:attributes="value request/fieldset|nothing" />
            <div class="row">
              <div class="field">
                <input type="text" name="name" value=""> 
                <input type="submit" name="schema_add_field" value=" Add new field " class="standalone">
              </div>
            </div>
          </form>

        </td>

        <td valign="top" tal:condition="not: request/field|nothing">  <!-- field editor -->
          <form action="schema_update" method="post">
            <input type="hidden" name="fielddata.schemata:record:string"    
                   tal:attributes="value request/fieldset|nothing" />
            <div class="row">
              <div class="field">
                <input type="text" name="name" value=""> 
                <input type="submit" name="schema_add_field" value=" Add new field " class="standalone">
              </div>
            </div>
          </form>

        </td>

      </tr>

    </table>

  </div>
</body>
</html>
