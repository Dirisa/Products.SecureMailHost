  <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US"
    lang="en-US"
    metal:use-macro="here/main_template/macros/master"
    i18n:domain="gruf">

    <metal:border fill-slot="head_slot">
      <tal:border define="dummy python:request.set('enable_border',1)" />
    </metal:border>

    <body>

      <div metal:fill-slot="main"
        tal:define="Iterator python:modules['Products.CMFPlone'].IndexIterator;
        Batch python:modules['Products.CMFPlone'].Batch;
        can_change python:here.canChange();
        group_submit request/group_submit|nothing;
        b_size python:12;b_start python:0;b_start request/b_start | b_start;
        tabindex python:Iterator();
        search_submitted request/role_submit|nothing;
        search_results python:test(search_submitted, here.portal_membership.searchMembers(
        search_param=request.get('search_param',''),
        search_term=request.get('search_term', '') ), None);">

        <h1 i18n:translate="heading_currently_assigned_shares">
          Current members of
          <span tal:content="here/title_or_id" i18n:name="folder">title</span>
        </h1>

        <form method="post"
              name="GroupSpace_remove_members"
              action="folder_localrole_edit"
              tal:attributes="action string:${here/absolute_url}/GroupSpace_remove_members"
          >

          <fieldset>

            <legend i18n:translate="legend_assigned_roles">
              Members in
              <span tal:content="here/title_or_id" i18n:name="folder">title</span> GroupSpace
            </legend>

            <input type="hidden" name="change_type" value="delete" />
              <input type="hidden" name="member_role" value="" />

                <table class="listing" summary="Current members"
                       tal:define="username python:here.portal_membership.getAuthenticatedMember().getUserName();">
                  <thead>
                    <tr>
                      <th tal:condition="can_change">&nbsp;</th>
                      <th i18n:translate="label_user_group_name">User/Group name</th>
              <th i18n:translate="label_type">Type</th>
            </tr>
            </thead>
              <tbody>
                <tr tal:repeat="lrole python:here.listMembersForDisplay()">
                  <td class="field" tal:condition="can_change">
                    <label class="hiddenLabel" for="member_ids:list"
                           i18n:translate="label_select_usergroup">
                      select user/group <span tal:content="python:lrole[2]" i18n:name="role"/>
            </label>
              <input class="formSelection"
                     type="checkbox"
                     name="member_ids:list"
                     id="#"
                     value=""
                     tabindex=""
                     tal:condition="python:lrole[0]!=username"
                tal:attributes="value python:lrole[2];
                tabindex tabindex/next"
                />
              </td>

                <td tal:content="python:lrole[0]">
                  groupname
                </td>

                <td tal:condition="python:lrole[1]=='group'"
                  i18n:translate="label_group">
                  Group
                </td>
                <td tal:condition="python:lrole[1]=='user'"
                  i18n:translate="label_user">
                  User
                </td>
                <td tal:condition="python:lrole[1]=='unknown'"
                  i18n:translate="label_unknown">
                  Unknown
                </td>

                <td tal:replace="nothing">
                  <tal:block tal:repeat="role python:lrole[1]">
                    <span i18n:translate=""
                      tal:content="role"
                      tal:omit-tag="">Role</span>
                    <span tal:condition="not: repeat/role/end"
                      tal:omit-tag="">, </span>
                  </tal:block>
                </td>
              </tr>
              </tbody>
              </table>

                <div class="submit">
                  <input class="context"
                         type="submit"
                         value="Remove Selected Member(s)"
                         i18n:attributes="value"
                    tabindex=""
                    tal:attributes="tabindex tabindex/next;"
                    tal:condition="can_change"
                    />
                </div>

          </fieldset>

        </form>

        <tal:block tal:replace="nothing">

          <metal:block tal:condition="python:test(search_submitted and not search_results, 1, 0)">
            <h1 i18n:translate="heading_search_results">Search results</h1>
            <p i18n:translate="no_members_found">
              No members were found using your <strong>Search Criteria</strong>
            </p>
            <hr />
          </metal:block>

          <metal:block tal:condition="python:test(search_submitted and search_results, 1, 0)">

            <h1 i18n:translate="heading_search_results">Search results</h1>

            <p i18n:translate="description_localrole_select_member">
              Select one or more Members, and a role to assign.
            </p>

            <metal:block tal:define="batch python:Batch(search_results, b_size, int(b_start), orphan=3)">

              <form method="post"
                    name="change_type"
                    action="folder_localrole_edit"
                    tal:attributes="action string:${here/absolute_url}/folder_localrole_edit">

                <fieldset>

                  <legend i18n:translate="legend_available_members">Available Members</legend>

                  <input type="hidden" name="change_type" value="add" />

                    <!-- batch navigation -->
                    <div metal:use-macro="here/batch_macros/macros/navigation" />

                  <table class="listing" summary="Search results">
                    <thead>
                      <tr>
                        <th>&nbsp;</th>
                        <th i18n:translate="label_user_name">User Name</th>
                        <th i18n:translate="label_email_address">Email Address</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr tal:repeat="member batch">
                        <td class="field">
                          <label class="hiddenLabel" for="member_ids:list"
                                 i18n:translate="label_select_user">
                            select user <span tal:content="member/username" i18n:name="user" />
                          </label>
                          <input class="formSelection"
                                 type="checkbox"
                                 name="member_ids:list"
                                 id="#"
                                 value=""
                                 tabindex=""
                                 tal:attributes="value member/username;
                            tabindex tabindex/next;"
                            />
                        </td>

                        <td tal:content="member/username">username</td>
                        <td tal:content="member/email">email</td>
                      </tr>
                    </tbody>
                  </table>

                  <!-- batch navigation -->
                  <div metal:use-macro="here/batch_macros/macros/navigation" />

                    <div class="field">

                      <label for="user_member_role" i18n:translate="label_localrole_to_assign">
                        Role to assign
                      </label>

                      <select name="member_role"
                              id="user_member_role"
                              tabindex=""
                              tal:attributes="tabindex tabindex/next;">
                        <option tal:repeat="lroles python:container.portal_membership.getCandidateLocalRoles(here)"
                          tal:attributes="value lroles"
                          tal:content="lroles"
                          i18n:translate="">
                          Role name
                        </option>
                      </select>

                    </div>

                    <div class="submit">
                      <input class="context"
                             type="submit"
                             value="Assign Local Role to Selected User(s)"
                             i18n:attributes="value"
                        tabindex=""
                        tal:attributes="tabindex tabindex/next;"
                        />
                    </div>

                </fieldset>

              </form>

            </metal:block>
          </metal:block>
        </tal:block>

        <div>

          <tal:block tal:replace="nothing">

            <tal:block tal:condition="python: (not search_submitted or
              (search_submitted and not search_results))">

              <h1 i18n:translate="heading_add_sharing_folder">
                Add shares for
                <tal:block tal:content="here/title_or_id" i18n:name="folder">title</tal:block>
              </h1>


              <p i18n:translate="description_sharing_folder">
                Sharing folders is an easy way to allow others access to edit and collaborate
                on your content.

                To share the contents of this folder, search for the person's
                name or email address in the form below, and assign them an appropriate role.
                The most common use is to give people Manager permissions, which means they
                have full control in this folder.
              </p>

              <form method="post"
                    name="localrole"
                    action="folder_localrole_form"
                    tal:attributes="action string:${here/absolute_url}/${template/getId}" >

                <fieldset>

                  <legend i18n:translate="legend_search_terms">Search Terms</legend>

                  <input type="hidden" name="role_submit" value="role_submit" />

                    <div class="field">
                      <label for="search_param" i18n:translate="label_search_by">
                        Search by
                      </label>

                      <select name="search_param"
                              id="search_param"
                              tabindex=""
                              tal:attributes="tabindex tabindex/next;">
                  <option value="username" i18n:translate="label_user_name">
                    User Name
                  </option>
                  <option value="email" i18n:translate="label_email_address">
                    Email Address
                  </option>
                </select>

        </div>

        <div class="field">
          <label for="search_term" i18n:translate="label_search_term">
            Search Term
          </label>

          <input type="text"
                 id="search_term"
                 name="search_term"
                 size="30"
                 tabindex=""
                 tal:attributes="tabindex tabindex/next;"
            />
        </div>

        <div class="submit">
          <input class="context"
                 type="submit"
                 value="Perform Search"
                 i18n:attributes="value"
            tabindex=""
            tal:attributes="tabindex tabindex/next;"
            />
        </div>

      </fieldset>

      </form>
      </tal:block>

      </tal:block>

        <tal:block tal:condition="can_change">

          <tal:block tal:define="list_groups python:[ grp for grp in here.portal_groups.listGroups() if grp.getUserName() not in here.listMemberIds() ]"
            tal:condition="list_groups">
            <h1 i18n:translate="heading_group_shares">Adding groups</h1>
            
            <p i18n:translate="description_group_shares">
              Select one or more Groups to add them to the current GroupSpace members.
            </p>

            <form method="post"
                  name="change_type"
                  action="GroupSpace_add_groups"
                  tal:attributes="action string:${here/absolute_url}/GroupSpace_add_groups">

              <fieldset>

                <legend i18n:translate="legend_available_groups">
                  Available Groups
                </legend>

                <input type="hidden" name="change_type" value="add" />

                  <table class="listing" summary="Available groups">
                    <thead>
                      <tr>
                        <th>&nbsp;</th>
                        <th i18n:translate="">Name</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr tal:repeat="member list_groups">
                <td>
                  <label class="hiddenLabel" for="member_ids:list"
                         i18n:translate="label_select_group">
                    select group <span tal:content="member/getUserName" i18n:name="name"/>
                  </label>
                  <input class="formSelection"
                         type="checkbox"
                         name="member_ids:list"
                         id="#"
                         value=""
                         tabindex=""
                         tal:attributes="value member/getUserName;
                    tabindex tabindex/next;"/>
                </td>
                <td tal:content="python:member.getUserNameWithoutGroupPrefix()">
                  groupname
                </td>
              </tr>
              </tbody>
              </table>

                <div class="submit">
                  <input class="context"
                         type="submit"
                         value="Add Selected Group(s)"
                         i18n:attributes="value"
                    tabindex=""
                    tal:attributes="tabindex tabindex/next;"
                    />
                </div>

              </fieldset>

            </form>

          </tal:block>
        </tal:block>
      </div>
      
    </div> <!-- fill-slot -->
      
    </body>
  </html>
